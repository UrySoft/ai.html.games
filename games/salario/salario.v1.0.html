<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="documentTitle">Dashboard Salarial</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --primary-hover: #0069d9;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #212529;
            --text-muted: #6c757d;
            --border-color: #e9ecef;
            --state-color: #fd7e14;
            --company-color: #dc3545;
            --employee-color: #198754;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.1);
        }
        body.dark-theme {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --text-muted: #888;
            --border-color: #2c2c2c;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.4);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 2rem 1rem;
            display: flex;
            justify-content: center;
            transition: background-color 0.3s, color 0.3s;
        }
        main {
            background-color: var(--card-bg);
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 1400px;
            transition: background-color 0.3s;
        }
        .header-container { text-align: center; margin-bottom: 2rem; }
        h1 { font-size: 2.25rem; margin: 0; }
        .top-controls { display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-top: 1rem; flex-wrap: wrap; }
        .author-credit { display: flex; align-items: center; gap: 0.5rem; flex-grow: 1; justify-content: center; }
        .author-credit a { color: var(--text-muted); text-decoration: none; font-weight: 500; transition: color 0.2s; }
        .author-credit a:hover { color: var(--primary-color); }
        .author-credit svg { width: 16px; height: 16px; fill: currentColor; }
        h2 { text-align: center; font-weight: 700; font-size: 1.75rem; margin-top: 2rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        
        #lang-selector { background-color: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.25rem 0.5rem; font-family: 'Inter', sans-serif; font-weight: 500;}
        .control-switch-wrapper { display: flex; align-items: center; gap: 0.5rem; font-weight: 500; }
        .control-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .control-switch input { opacity: 0; width: 0; height: 0; }
        .control-slider { position: absolute; cursor: pointer; inset: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .control-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        .control-slider-icon { position: absolute; top: 50%; transform: translateY(-50%); font-size: 12px; font-weight: bold; color: var(--bg-color); user-select: none; }
        .icon-on { right: 7px; opacity: 1; transition: opacity 0.4s; }
        .icon-off { left: 7px; opacity: 0; transition: opacity 0.4s; }
        input:checked + .control-slider { background-color: var(--primary-color); }
        input:checked + .control-slider:before { transform: translateX(20px); }
        input:checked + .control-slider .icon-on { opacity: 0; }
        input:checked + .control-slider .icon-off { opacity: 1; }

        .input-section { display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem; margin-bottom: 2rem; }
        label { font-weight: 600; }
        input[type="number"] { background-color: var(--card-bg); color: var(--text-color); width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1.1rem; box-sizing: border-box; transition: all 0.2s; }
        input[type="number"]:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); outline: none; }
        input[readonly] { background-color: var(--bg-color); color: var(--text-muted); cursor: not-allowed; border-style: dashed; }
        button { background-color: var(--primary-color); color: white; border: none; padding: 0.75rem 1.5rem; font-size: 1.1rem; font-weight: 600; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; height: fit-content;}
        button:hover { background-color: var(--primary-hover); }
        #results { display: none; }
        .results-header { display: flex; justify-content: center; margin-bottom: 1.5rem; }
        .disclaimer { font-size: 0.8rem; color: var(--text-muted); background-color: var(--bg-color); border-radius: 8px; padding: 0.75rem; margin-top: 1.5rem; line-height: 1.5; }
        .summary-section { display: flex; flex-wrap: wrap; gap: 2rem; align-items: center; }
        .summary-grid { flex: 1 1 300px; display: grid; gap: 1rem; }
        .summary-chart-container { flex: 1 1 250px; min-width: 250px; }
        .summary-card { background-color: var(--card-bg); padding: 1.25rem; border-radius: 12px; display: flex; flex-direction: column; justify-content: space-between; gap: 0.5rem; box-shadow: var(--shadow-md); transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; }
        .summary-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .summary-card .label { font-weight: 600; font-size: 1rem; }
        .summary-card .value { font-size: 1.75rem; font-weight: 700; font-family: monospace; white-space: nowrap; align-self: flex-end; margin-top: 0.5rem; }
        .summary-card.company .value { color: var(--company-color); }
        .summary-card.state .value { color: var(--state-color); }
        .summary-card.employee .value { color: var(--employee-color); }
        .breakdown-card { border-radius: 12px; background-color: var(--card-bg); margin-top: 1rem; box-shadow: var(--shadow-sm); overflow: hidden; transition: background-color 0.3s; }
        .breakdown-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.25rem; }
        .card-info { font-weight: 600; font-size: 1.1rem; }
        .value-wrapper { display: flex; flex-direction: column; align-items: flex-end; }
        .breakdown-header .value { font-family: monospace; font-size: 1.5rem; font-weight: 700; white-space: nowrap; }
        .breakdown-header .percentages { font-size: 0.85rem; color: var(--text-muted); margin-top: 4px; }
        .nested-cards { padding: 0 1rem 1rem 1rem; background-color: rgba(0,0,0,0.02); border-top: 1px solid var(--border-color); }
        body.dark-theme .nested-cards { background-color: rgba(255,255,255,0.03); }
        .company-cost { border-left: 4px solid var(--company-color); }
        .state-tax { border-left: 4px solid var(--state-color); }
        .employee-gross { border-left: 4px solid var(--text-color); }
        .employee-net { border-left: 4px solid var(--employee-color); }
        .tax-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .tax-table th, .tax-table td { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); text-align: left; transition: background-color 0.3s; }
        .tax-table thead th { font-weight: 600; color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase; }
        .tax-table .numeric-cell { text-align: right; font-family: monospace; }
        .tax-table tbody tr:hover td { background-color: var(--bg-color); }
        .tax-table tfoot td { font-weight: 700; border-top: 2px solid var(--text-color); }
        .evolution-controls { display: flex; align-items: flex-end; gap: 1rem; margin-top: 1rem; flex-wrap: wrap; }
        .evolution-controls .input-wrapper { display: flex; flex-direction: column; gap: 0.25rem; }
        .evolution-controls .input-container { display: flex; align-items: center; gap: 0.5rem; }
        .evolution-controls input { text-align: right; width: 120px; }
        .comparison-controls-container { display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .comparison-controls, .comparison-mode-controls { display: flex; justify-content: center; gap: 0.5rem; flex-wrap: wrap; }
        .comparison-controls button, .comparison-mode-controls button { font-size: 0.9rem; padding: 0.5rem 1rem; background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 8px; }
        .comparison-controls button.active, .comparison-mode-controls button.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); font-weight: 600; }
        #comparison-mode-description {
            text-align: center;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }

        .dashboard-grid {
            display: grid;
            gap: 2.5rem;
            align-items: flex-start;
        }
        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }
            #summary-section { grid-column: 1 / 2; grid-row: 1 / 2; }
            #evolution-section { grid-column: 2 / 3; grid-row: 1 / 2; }
            #breakdown-section { grid-column: 1 / 2; grid-row: 2 / 3; }
            #tax-distribution-section { grid-column: 2 / 3; grid-row: 2 / 3; }
            #comparison-section { grid-column: 1 / -1; grid-row: 3 / 4; }
        }
    </style>
</head>
<body>
    <main>
        <div class="header-container">
            <h1 data-translate-key="pageTitle"></h1>
            <div class="top-controls">
                <div class="author-credit"><span data-translate-key="authorBy"></span><a href="https://www.linkedin.com/in/oriol-badia" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" aria-hidden="true"><g><path d="M20.5 2h-17A1.5 1.5 0 002 3.5v17A1.5 1.5 0 003.5 22h17a1.5 1.5 0 001.5-1.5v-17A1.5 1.5 0 0020.5 2zM8 19H5v-9h3zM6.5 8.25A1.75 1.75 0 114.75 6.5 1.75 1.75 0 016.5 8.25zM19 19h-3v-4.75c0-1.4-1.2-2.5-2.5-2.5S11 12.85 11 14.25V19h-3v-9h2.9v1.3a3.11 3.11 0 012.6-1.4c2.5 0 4.5 2.1 4.5 5.1V19z"></path></g></svg><span>Oriol Badia Campanera</span></a></div>
                <select id="lang-selector">
                    <option value="es">Castellano</option><option value="ca">Català</option><option value="eu">Euskara</option><option value="gl">Galego</option><option value="oc">Aranés</option><option value="en">English</option>
                </select>
                <div class="control-switch-wrapper"><label class="control-switch"><input type="checkbox" id="theme-toggle"><span class="control-slider"><span class="control-slider-icon icon-on">☀️</span><span class="control-slider-icon icon-off">🌙</span></span></label></div>
            </div>
        </div>
        <div class="input-section">
            <label for="sueldo-bruto" data-translate-key="grossSalaryLabel"></label>
            <input type="number" id="sueldo-bruto" data-translate-placeholder="grossSalaryPlaceholder" min="0">
            <button id="calculate-btn" data-translate-key="calculateBtn"></button>
        </div>
        <div id="results">
            <div class="results-header">
                <div class="control-switch-wrapper">
                    <span data-translate-key="annual"></span>
                    <label class="control-switch"><input type="checkbox" id="period-toggle"><span class="control-slider"><span class="control-slider-icon icon-on">A</span><span class="control-slider-icon icon-off">M</span></span></label>
                    <span data-translate-key="monthly"></span>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <div id="summary-section">
                    <h2 data-translate-key="summaryTitle"></h2>
                    <div class="summary-grid">
                        <div class="summary-card company"><div class="summary-content"><span class="label" data-translate-key="companyInvests"></span></div><span class="value" id="summary-empresa"></span></div>
                        <div class="summary-card state"><div class="summary-content"><span class="label" data-translate-key="stateCollects"></span></div><span class="value" id="summary-estado"></span></div>
                        <div class="summary-card employee"><div class="summary-content"><span class="label" data-translate-key="employeeReceives"></span></div><span class="value" id="summary-trabajador"></span></div>
                    </div>
                    <div class="summary-chart-container"><div id="summary-chart"></div></div>
                </div>

                <div id="evolution-section">
                    <h2 data-translate-key="evolutionTitle"></h2>
                    <div class="evolution-controls">
                        <div class="input-wrapper"><label for="evolution-smi" data-translate-key="fromSMI"></label><div class="input-container"><input type="number" id="evolution-smi" readonly><span>€</span></div></div>
                        <div class="input-wrapper"><label for="evolution-max-salary" data-translate-key="upTo"></label><div class="input-container"><input type="number" id="evolution-max-salary"><span>€</span></div></div>
                        <button id="redraw-evolution-btn" data-translate-key="updateChartBtn"></button>
                    </div>
                    <div id="evolution-chart"></div>
                    <p class="disclaimer" data-translate-key="evolutionDisclaimer"></p>
                </div>

                <div id="breakdown-section">
                    <h2 data-translate-key="breakdownTitle"></h2>
                    <div id="breakdown-chart"></div>
                    <div id="breakdown-container"></div>
                </div>

                <div id="tax-distribution-section">
                    <h2 data-translate-key="taxDistributionTitle"></h2>
                    <div id="tax-distribution-chart"></div>
                    <table class="tax-table">
                        <thead><tr><th data-translate-key="taxDestination"></th><th class="numeric-cell" data-translate-key="taxPercentagePGE"></th><th class="numeric-cell" data-translate-key="taxYourContribution"></th></tr></thead>
                        <tbody id="tax-tbody"></tbody>
                        <tfoot><tr><td data-translate-key="total"></td><td></td><td class="numeric-cell" id="tax-total"></td></tr></tfoot>
                    </table>
                    <p class="disclaimer" data-translate-key="taxDisclaimer"></p>
                </div>

                <div id="comparison-section">
                    <h2 data-translate-key="comparisonTitle"></h2>
                    <div class="comparison-controls-container">
                        <div class="comparison-mode-controls">
                            <button id="mode-real-btn" class="active" data-translate-key="comparisonModeReal"></button>
                            <button id="mode-hypothesis-btn" data-translate-key="comparisonModeHypothesis"></button>
                        </div>
                        <div class="comparison-controls">
                            <button id="sort-by-cost" class="active" data-translate-key="sortByCompanyCost"></button>
                            <button id="sort-by-tax" data-translate-key="sortByStateRevenue"></button>
                            <button id="sort-by-net" data-translate-key="sortByNetSalary"></button>
                        </div>
                    </div>
                    <p id="comparison-mode-description" data-translate-key="comparisonDisclaimerReal"></p>
                    <div id="comparison-chart"></div>
                    <p class="disclaimer" data-translate-key="comparisonDisclaimerNote"></p>
                </div>
            </div>
            
            <p class="disclaimer" data-translate-key="generalDisclaimer"></p>
        </div>
    </main>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // UI ELEMENTS
            const calculateBtn = document.getElementById('calculate-btn');
            const sueldoBrutoInput = document.getElementById('sueldo-bruto');
            const periodToggle = document.getElementById('period-toggle');
            const themeToggle = document.getElementById('theme-toggle');
            const langSelector = document.getElementById('lang-selector');
            const redrawEvolutionBtn = document.getElementById('redraw-evolution-btn');
            const evolutionSmiInput = document.getElementById('evolution-smi');
            const evolutionMaxInput = document.getElementById('evolution-max-salary');
            const sortCostBtn = document.getElementById('sort-by-cost');
            const sortTaxBtn = document.getElementById('sort-by-tax');
            const sortNetBtn = document.getElementById('sort-by-net');
            const modeRealBtn = document.getElementById('mode-real-btn');
            const modeHypothesisBtn = document.getElementById('mode-hypothesis-btn');
            const comparisonModeDescription = document.getElementById('comparison-mode-description');
            
            // STATE & CONSTANTS
            let annualValues = {};
            let comparisonData = [];
            let currentSortCriteria = 'costeEmpresa';
            let comparisonMode = 'real';
            let evolutionMaxSalaryAnnual = 100000;
            let charts = { summary: null, breakdown: null, evolution: null, comparison: null, taxDistribution: null };
            let currentLang = 'es';

            const SMI_ANNUAL = 15876;
            const PGE_DISTRIBUTION = [ { key: 'pensions', percent: 0.389 }, { key: 'debt', percent: 0.115 }, { key: 'transfers', percent: 0.101 }, { key: 'unemployment', percent: 0.076 }, { key: 'health', percent: 0.061 }, { key: 'education', percent: 0.052 }, { key: 'publicServices', percent: 0.045 }, { key: 'fomento', percent: 0.041 }, { key: 'defense', percent: 0.038 }, { key: 'industry', percent: 0.031 }, { key: 'rdi', percent: 0.025 }, { key: 'culture', percent: 0.025 }, { key: 'royalHouse', percent: 0.001 }];
            
            const countryData = {
                'FR': { ss_empresa: 0.45, ss_trabajador: 0.22, get_irpf: (s) => { if (s <= 11294) return 0; if (s <= 28797) return 0.11; if (s <= 82341) return 0.30; return 0.41; } },
                'BE': { ss_empresa: 0.25, ss_trabajador: 0.1307, get_irpf: (s) => { if (s <= 15200) return 0.25; if (s <= 26830) return 0.40; if (s <= 46440) return 0.45; return 0.50; } },
                'IT': { ss_empresa: 0.30, ss_trabajador: 0.0919, get_irpf: (s) => { if (s <= 15000) return 0.23; if (s <= 28000) return 0.25; if (s <= 50000) return 0.35; return 0.43; } },
                'SE': { ss_empresa: 0.3142, ss_trabajador: 0.07, get_irpf: (s) => 0.32 },
                'DE': { ss_empresa: 0.195, ss_trabajador: 0.205, get_irpf: (s) => { if (s <= 11604) return 0; if (s <= 66760) return 0.28; return 0.42; } },
                'ES': { ss_empresa: 0.32, ss_trabajador: 0.0645, get_irpf: (s) => { if (s <= 15000) return 0.15; if (s <= 25000) return 0.19; if (s <= 35000) return 0.22; if (s <= 50000) return 0.26; return 0.32; } },
                'PT': { ss_empresa: 0.2375, ss_trabajador: 0.11, get_irpf: (s) => { if (s <= 7703) return 0.145; if (s <= 11623) return 0.21; if (s <= 21321) return 0.26; return 0.35; } },
                'NL': { ss_empresa: 0.18, ss_trabajador: 0.2765, get_irpf: (s) => { if (s <= 73031) return 0.3693; return 0.495; } },
                'UK': { ss_empresa: 0.138, ss_trabajador: 0.12, get_irpf: (s) => { const s_gbp = s * 0.85; if (s_gbp <= 12570) return 0; if (s_gbp <= 50270) return 0.20; return 0.40; } },
                'IE': { ss_empresa: 0.1105, ss_trabajador: 0.04, get_irpf: (s) => { if (s <= 40000) return 0.20; return 0.40; } },
                'CH': { ss_empresa: 0.065, ss_trabajador: 0.065, get_irpf: (s) => 0.11 },
                'US': { ss_empresa: 0.0765, ss_trabajador: 0.0765, get_irpf: (s) => { const s_usd = s * 1.1; if (s_usd <= 11000) return 0.10; if (s_usd <= 44725) return 0.12; if (s_usd <= 95375) return 0.22; return 0.24; } },
                'MX': { ss_empresa: 0.20, ss_trabajador: 0.028, get_irpf: (s) => { if (s <= 4500) return 0.05; if (s <= 10000) return 0.10; if (s <= 20000) return 0.17; return 0.25; } },
                'BR': { ss_empresa: 0.28, ss_trabajador: 0.11, get_irpf: (s) => { if (s <= 5000) return 0; if (s <= 7000) return 0.075; if (s <= 9500) return 0.15; return 0.225; } },
                'AR': { ss_empresa: 0.24, ss_trabajador: 0.17, get_irpf: (s) => { if (s <= 3000) return 0.05; if (s <= 6000) return 0.12; if (s <= 9000) return 0.19; return 0.27; } },
                'CL': { ss_empresa: 0.06, ss_trabajador: 0.18, get_irpf: (s) => { if (s <= 10000) return 0; if (s <= 22000) return 0.04; if (s <= 38000) return 0.08; return 0.135; } },
                'CO': { ss_empresa: 0.21, ss_trabajador: 0.08, get_irpf: (s) => { if (s <= 12000) return 0; if (s <= 18000) return 0.19; if (s <= 45000) return 0.28; return 0.33; } },
            };

            const fullTranslations = {
                es: {
                    documentTitle: 'Dashboard Salarial', pageTitle: 'Dashboard Salarial', authorBy: 'por',
                    grossSalaryLabel: 'Sueldo Bruto Anual (€)', grossSalaryPlaceholder: 'Ej: 30000', calculateBtn: 'Generar Dashboard',
                    annual: 'Anual', monthly: 'Mensual', summaryTitle: 'Resumen Financiero',
                    companyInvests: 'La empresa invierte', stateCollects: 'El Estado recauda', employeeReceives: 'El trabajador recibe',
                    evolutionTitle: '📈 Evolución Salarial', fromSMI: 'Desde (SMI)', upTo: 'Hasta', updateChartBtn: 'Actualizar',
                    evolutionDisclaimer: 'Este gráfico muestra la evolución de los costes e ingresos según el sueldo bruto. La línea vertical marca la posición del salario introducido.',
                    breakdownTitle: 'Desglose de Costes', taxDistributionTitle: '🏛️ ¿A qué se destinan tus impuestos?',
                    taxDestination: 'Destino del Gasto', taxPercentagePGE: '% PGE', taxYourContribution: 'Tu Aportación', total: 'Total',
                    taxDisclaimer: 'Nota: Esta tabla distribuye el total de impuestos (IRPF + S.S.) según los porcentajes de gasto de los PGE 2023. Es un modelo ilustrativo.',
                    generalDisclaimer: 'Aviso General: Este cálculo es una estimación. Las cifras reales pueden variar según convenio, tipo de contrato, situación personal, etc.',
                    totalCompanyCost: '💰 Coste Total Empresa', ssCompany: '🏛️ S.S. (Empresa)', grossSalary: '💼 Sueldo Bruto', irpf: '🏛️ IRPF (Retención)', ssEmployee: '🏛️ S.S. (Trabajador)', netSalary: '✅ Sueldo Neto',
                    ofTotal: 'del total', ofGross: 'del bruto',
                    chartLabelState: 'Recaudado por el Estado', chartLabelNet: 'Recibido por el Trabajador (Neto)',
                    chartSeriesCompany: 'Coste Empresa', chartSeriesState: 'Recaudado Estado', chartSeriesNet: 'Sueldo Neto',
                    yourSalary: 'Tu Salario',
                    pensions: 'Pensiones', debt: 'Deuda Pública (intereses)', transfers: 'Transf. a Adm. Públicas', unemployment: 'Desempleo', health: 'Sanidad', education: 'Educación', publicServices: 'Servicios Públicos Generales', fomento: 'Fomento', defense: 'Defensa y Seguridad', industry: 'Industria y Energía', rdi: 'I+D+i y Digitalización', culture: 'Cultura y otros', royalHouse: 'Casa Real',
                    comparisonTitle: '🌍 Comparativa Internacional', sortByCompanyCost: 'Ordenar por Coste Empresa', sortByStateRevenue: 'Ordenar por Impuestos', sortByNetSalary: 'Ordenar por Sueldo Neto',
                    comparisonModeReal: 'Análisis Real', comparisonModeHypothesis: 'Análisis Hipotético',
                    comparisonDisclaimerReal: 'Análisis Real: Compara los sistemas fiscales aplicando tu sueldo bruto a cada país.',
                    comparisonDisclaimerHypothesis: 'Análisis Hipotético: Compara qué sueldo tendrías si la inversión total de la empresa fuera la misma que en España.',
                    comparisonDisclaimerNote: 'Nota: Modelos fiscales y de seguridad social muy simplificados. Propósito puramente ilustrativo.',
                    country_es: 'España', country_de: 'Alemania', country_fr: 'Francia', country_uk: 'Reino Unido', country_us: 'EE.UU.', country_br: 'Brasil', country_be: 'Bélgica', country_it: 'Italia', country_se: 'Suecia', country_pt: 'Portugal', country_nl: 'Países Bajos', country_ie: 'Irlanda', country_ch: 'Suiza', country_mx: 'México', country_ar: 'Argentina', country_cl: 'Chile', country_co: 'Colombia',
                    compChartNet: 'Sueldo Neto', compChartStateRevenue: 'Recaudado por Estado'
                },
                en: {
                    documentTitle:'Salary Dashboard',pageTitle:'Salary Dashboard',authorBy:'by',grossSalaryLabel:'Annual Gross Salary (€)',grossSalaryPlaceholder:'e.g.: 30000',calculateBtn:'Generate Dashboard',annual:'Annual',monthly:'Monthly',summaryTitle:'Financial Summary',companyInvests:'Company invests',stateCollects:'State collects',employeeReceives:'Employee receives',evolutionTitle:'📈 Salary Evolution',fromSMI:'From (SMI)',upTo:'Up to',updateChartBtn:'Update chart',evolutionDisclaimer:'This chart shows the evolution of costs and income based on the gross salary. The vertical line marks your entered salary.',breakdownTitle:'Cost Breakdown',taxDistributionTitle:'🏛️ Where your taxes go',taxDestination:'Destination of Spending',taxPercentagePGE:'% PGE',taxYourContribution:'Your Contribution',total:'Total',taxDisclaimer:'Note: This table distributes total taxes (IRPF + S.S.) according to the 2023 PGE spending percentages. Illustrative model.',generalDisclaimer:'General disclaimer: This is an estimate. Actual figures may vary by contract, personal situation, etc.',totalCompanyCost:'💰 Total Company Cost',ssCompany:'🏛️ S.S. (Company)',grossSalary:'💼 Gross Salary',irpf:'🏛️ IRPF (Withholding)',ssEmployee:'🏛️ S.S. (Employee)',netSalary:'✅ Net Salary',ofTotal:'of total',ofGross:'of gross',chartLabelState:'Collected by State',chartLabelNet:'Received by Employee (Net)',chartSeriesCompany:'Company Cost',chartSeriesState:'State Revenue',chartSeriesNet:'Net Salary',yourSalary:'Your Salary',pensions:'Pensions',debt:'Public Debt (interest)',transfers:'Transfers to Public Admin',unemployment:'Unemployment',health:'Healthcare',education:'Education',publicServices:'General Public Services',fomento:'Development',defense:'Defense & Security',industry:'Industry & Energy',rdi:'R&D & Digitization',culture:'Culture & Others',royalHouse:'Royal Household',comparisonTitle:'🌍 International Comparison',sortByCompanyCost:'Sort by Company Cost',sortByStateRevenue:'Sort by Taxes',sortByNetSalary:'Sort by Net Salary',comparisonModeReal:'Real Analysis',comparisonModeHypothesis:'Hypothetical Analysis',comparisonDisclaimerReal:'Real Analysis: compare tax systems applying your gross salary to each country.',comparisonDisclaimerHypothesis:'Hypothetical Analysis: what salary you would have if company investment matched Spain’s.',comparisonDisclaimerNote:'Note: very simplified models. Purely illustrative.',country_es:'Spain',country_de:'Germany',country_fr:'France',country_uk:'United Kingdom',country_us:'USA',country_br:'Brazil',country_be:'Belgium',country_it:'Italy',country_se:'Sweden',country_pt:'Portugal',country_nl:'Netherlands',country_ie:'Ireland',country_ch:'Switzerland',country_mx:'Mexico',country_ar:'Argentina',country_cl:'Chile',country_co:'Colombia',compChartNet:'Net Salary',compChartStateRevenue:'Collected by State'
                },
                ca: {
                    documentTitle: 'Dashboard Salarial', pageTitle: 'Dashboard Salarial', authorBy: 'per', grossSalaryLabel: 'Sou Brut Anual (€)', grossSalaryPlaceholder: 'Ex: 30000', calculateBtn: 'Generar Dashboard', annual: 'Anual', monthly: 'Mensual', summaryTitle: 'Resum Financer', companyInvests: 'L\'empresa inverteix', stateCollects: 'L\'Estat recapta', employeeReceives: 'El treballador rep', evolutionTitle: '📈 Evolució Salarial', fromSMI: 'Des de (SMI)', upTo: 'Fins a', updateChartBtn: 'Actualitzar', evolutionDisclaimer: 'Aquest gràfic mostra l\'evolució dels costos i ingressos segons el sou brut. La línia vertical marca la posició del salari introduït.', breakdownTitle: 'Desglossament de Costos', taxDistributionTitle: '🏛️ A què es destinen els teus impostos?', taxDestination: 'Destinació de la Despesa', taxPercentagePGE: '% PGE', taxYourContribution: 'La teva Aportació', total: 'Total', taxDisclaimer: 'Nota: Aquesta taula distribueix el total d\'impostos (IRPF + S.S.) segons els percentatges de despesa dels PGE 2023. És un model il·lustratiu.', generalDisclaimer: 'Avís General: Aquest càlcul és una estimació. Les xifres reals poden variar segons conveni, tipus de contracte, situació personal, etc.', totalCompanyCost: '💰 Cost Total Empresa', ssCompany: '🏛️ S.S. (Empresa)', grossSalary: '💼 Sou Brut', irpf: '🏛️ IRPF (Retenció)', ssEmployee: '🏛️ S.S. (Treballador)', netSalary: '✅ Sou Net', ofTotal: 'del total', ofGross: 'del brut', chartLabelState: 'Recaptat per l\'Estat', chartLabelNet: 'Rebut pel Treballador (Net)', chartSeriesCompany: 'Cost Empresa', chartSeriesState: 'Recaptat Estat', chartSeriesNet: 'Sou Net', yourSalary: 'El Teu Salari', pensions: 'Pensions', debt: 'Deute Públic (interessos)', transfers: 'Transf. a Adm. Públiques', unemployment: 'Atur', health: 'Sanitat', education: 'Educació', publicServices: 'Serveis Públics Generals', fomento: 'Foment', defense: 'Defensa i Seguretat', industry: 'Indústria i Energia', rdi: 'R+D+i i Digitalització', culture: 'Cultura i altres', royalHouse: 'Casa Reial', comparisonTitle: '🌍 Comparativa Internacional', sortByCompanyCost: 'Ordenar per Cost Empresa', sortByStateRevenue: 'Ordenar per Impostos', sortByNetSalary: 'Ordenar per Sou Net', comparisonModeReal: 'Anàlisi Real', comparisonModeHypothesis: 'Anàlisi Hipotètica', comparisonDisclaimerReal: 'Anàlisi Real: Compara els sistemes fiscals aplicant el teu sou brut a cada país.', comparisonDisclaimerHypothesis: 'Anàlisi Hipotètica: Compara quin sou tindries si la inversió total de l\'empresa fos la mateixa que a Espanya.', comparisonDisclaimerNote: 'Nota: Models fiscals i de seguretat social molt simplificats. Propòsit purament il·lustratiu.', country_es: 'Espanya', country_de: 'Alemanya', country_fr: 'França', country_uk: 'Regne Unit', country_us: 'EUA', country_br: 'Brasil', country_be: 'Bèlgica', country_it: 'Itàlia', country_se: 'Suècia', country_pt: 'Portugal', country_nl: 'Països Baixos', country_ie: 'Irlanda', country_ch: 'Suïssa', country_mx: 'Mèxic', country_ar: 'Argentina', country_cl: 'Xile', country_co: 'Colòmbia', compChartNet: 'Sou Net', compChartStateRevenue: 'Recaptat per l\'Estat'
                },
                eu: {
                    documentTitle: 'Soldata Arbel', pageTitle: 'Soldata Arbel', authorBy: 'egilea', grossSalaryLabel: 'Urteko Soldata Gordina (€)', grossSalaryPlaceholder: 'Adib: 30000', calculateBtn: 'Arbela Sortu', annual: 'Urtekoa', monthly: 'Hilekoa', summaryTitle: 'Finantza Laburpena', companyInvests: 'Enpresak inbertitzen du', stateCollects: 'Estatuak biltzen du', employeeReceives: 'Langileak jasotzen du', evolutionTitle: '📈 Soldataren Eboluzioa', fromSMI: 'HGGtik (SMI)', upTo: 'Hona arte', updateChartBtn: 'Eguneratu', evolutionDisclaimer: 'Grafiko honek kostuen eta diru-sarreren bilakaera erakusten du soldata gordinaren arabera. Lerro bertikalak sartutako soldataren posizioa markatzen du.', breakdownTitle: 'Kostuen Banaketa', taxDistributionTitle: '🏛️ Zertara bideratzen dira zure zergak?', taxDestination: 'Gastuaren Helburua', taxPercentagePGE: '% PGE', taxYourContribution: 'Zure Ekarpena', total: 'Guztira', taxDisclaimer: 'Oharra: Taula honek zerga guztien (PFEZ + G.S.) banaketa egiten du, 2023ko PGEen gastu-portzentajeen arabera. Eredu argigarria da.', generalDisclaimer: 'Ohar Orokorra: Kalkulu hau estimazio bat da. Benetako zifrak alda daitezke hitzarmenaren, kontratu motaren, egoera pertsonalaren eta abarren arabera.', totalCompanyCost: '💰 Enpresaren Kostu Totala', ssCompany: '🏛️ G.S. (Enpresa)', grossSalary: '💼 Soldata Gordina', irpf: '🏛️ PFEZ (Atxikipena)', ssEmployee: '🏛️ G.S. (Langilea)', netSalary: '✅ Soldata Garbia', ofTotal: 'guztirakoaren', ofGross: 'gordinaren', chartLabelState: 'Estatuak Bildutakoa', chartLabelNet: 'Langileak Jasotakoa (Garbia)', chartSeriesCompany: 'Enpresa Kostua', chartSeriesState: 'Estatuak Bildutakoa', chartSeriesNet: 'Soldata Garbia', yourSalary: 'Zure Soldata', pensions: 'Pentsioak', debt: 'Zor Publikoa (interesak)', transfers: 'Beste Adm. Publikoei Transf.', unemployment: 'Langabezia', health: 'Osasuna', education: 'Hezkuntza', publicServices: 'Zerbitzu Publiko Orokorrak', fomento: 'Sustapena', defense: 'Defentsa eta Segurtasuna', industry: 'Industria eta Energia', rdi: 'I+G+b eta Digitalizazioa', culture: 'Kultura eta beste batzuk', royalHouse: 'Errege Etxea', comparisonTitle: '🌍 Nazioarteko Konparaketa', sortByCompanyCost: 'Ordenatu Enpresa Kostuaren arabera', sortByStateRevenue: 'Ordenatu Zergen arabera', sortByNetSalary: 'Ordenatu Soldata Garbiaren arabera', comparisonModeReal: 'Benetako Analisia', comparisonModeHypothesis: 'Analisi Hipotetikoa', comparisonDisclaimerReal: 'Benetako Analisia: Konparatu sistema fiskalak zure soldata gordina herrialde bakoitzean aplikatuz.', comparisonDisclaimerHypothesis: 'Analisi Hipotetikoa: Konparatu zer soldata izango zenukeen enpresaren inbertsio totala Espainiakoaren berdina balitz.', comparisonDisclaimerNote: 'Oharra: Eredu fiskal eta gizarte-segurantzako oso sinplifikatuak. Helburu argigarria soilik.', country_es: 'Espainia', country_de: 'Alemania', country_fr: 'Frantzia', country_uk: 'Erresuma Batua', country_us: 'AEB', country_br: 'Brasil', country_be: 'Belgika', country_it: 'Italia', country_se: 'Suedia', country_pt: 'Portugal', country_nl: 'Herbehereak', country_ie: 'Irlanda', country_ch: 'Suitza', country_mx: 'Mexiko', country_ar: 'Argentina', country_cl: 'Txile', country_co: 'Kolonbia', compChartNet: 'Soldata Garbia', compChartStateRevenue: 'Estatuak Bildutakoa'
        },
        gl: {
            documentTitle: 'Panel Salarial', pageTitle: 'Panel Salarial', authorBy: 'por', grossSalaryLabel: 'Soldo Bruto Anual (€)', grossSalaryPlaceholder: 'Ex: 30000', calculateBtn: 'Xerar Panel', annual: 'Anual', monthly: 'Mensual', summaryTitle: 'Resumo Financeiro', companyInvests: 'A empresa inviste', stateCollects: 'O Estado recada', employeeReceives: 'O traballador recibe', evolutionTitle: '📈 Evolución Salarial', fromSMI: 'Dende (SMI)', upTo: 'Ata', updateChartBtn: 'Actualizar', evolutionDisclaimer: 'Este gráfico amosa a evolución dos custos e ingresos segundo o soldo bruto. A liña vertical marca a posición do salario introducido.', breakdownTitle: 'Desglose de Custos', taxDistributionTitle: '🏛️ A que se destinan os teus impostos?', taxDestination: 'Destino do Gasto', taxPercentagePGE: '% PXE', taxYourContribution: 'A túa Aportación', total: 'Total', taxDisclaimer: 'Nota: Esta táboa distribúe o total de impostos (IRPF + S.S.) segundo as porcentaxes de gasto dos PXE 2023. É un modelo ilustrativo.', generalDisclaimer: 'Aviso Xeral: Este cálculo é unha estimación. As cifras reais poden variar segundo convenio, tipo de contrato, situación persoal, etc.', totalCompanyCost: '💰 Custo Total Empresa', ssCompany: '🏛️ S.S. (Empresa)', grossSalary: '💼 Soldo Bruto', irpf: '🏛️ IRPF (Retención)', ssEmployee: '🏛️ S.S. (Traballador)', netSalary: '✅ Soldo Neto', ofTotal: 'do total', ofGross: 'do bruto', chartLabelState: 'Recadado polo Estado', chartLabelNet: 'Recibido polo Traballador (Neto)', chartSeriesCompany: 'Custo Empresa', chartSeriesState: 'Recadado Estado', chartSeriesNet: 'Soldo Neto', yourSalary: 'O Teu Salario', pensions: 'Pensións', debt: 'Débeda Pública (xuros)', transfers: 'Transf. a Adm. Públicas', unemployment: 'Desemprego', health: 'Sanidade', education: 'Educación', publicServices: 'Servizos Públicos Xerais', fomento: 'Fomento', defense: 'Defensa e Seguridade', industry: 'Industria e Enerxía', rdi: 'I+D+i e Dixitalización', culture: 'Cultura e outros', royalHouse: 'Casa Real', comparisonTitle: '🌍 Comparativa Internacional', sortByCompanyCost: 'Ordenar por Custo Empresa', sortByStateRevenue: 'Ordenar por Impostos', sortByNetSalary: 'Ordenar por Soldo Neto', comparisonModeReal: 'Análise Real', comparisonModeHypothesis: 'Análise Hipotética', comparisonDisclaimerReal: 'Análise Real: Compara os sistemas fiscais aplicando o teu soldo bruto a cada país.', comparisonDisclaimerHypothesis: 'Análise Hipotética: Compara que soldo terías se o investimento total da empresa fose o mesmo que en España.', comparisonDisclaimerNote: 'Nota: Modelos fiscais e de seguridade social moi simplificados. Propósito puramente ilustrativo.', country_es: 'España', country_de: 'Alemaña', country_fr: 'Francia', country_uk: 'Reino Unido', country_us: 'EUA', country_br: 'Brasil', country_be: 'Bélxica', country_it: 'Italia', country_se: 'Suecia', country_pt: 'Portugal', country_nl: 'Países Baixos', country_ie: 'Irlanda', country_ch: 'Suíza', country_mx: 'México', country_ar: 'Arxentina', country_cl: 'Chile', country_co: 'Colombia', compChartNet: 'Soldo Neto', compChartStateRevenue: 'Recadado polo Estado'
        },
        oc: {
            documentTitle: 'Panèu Salariau', pageTitle: 'Panèu Salariau', authorBy: 'per', grossSalaryLabel: 'Sòlde Brut Anuau (€)', grossSalaryPlaceholder: 'Ex: 30000', calculateBtn: 'Generar Panèu', annual: 'Anuau', monthly: 'Mensuau', summaryTitle: 'Arresumit Financièr', companyInvests: 'Er\'entrepresa investís', stateCollects: 'Er\'Estat recapte', employeeReceives: 'Eth trabalhador recep', evolutionTitle: '📈 Evolucion Salariau', fromSMI: 'A compdar de (SMI)', upTo: 'Enquia', updateChartBtn: 'Actualizar', evolutionDisclaimer: 'Aguest grafic mòstre er\'evolucion des còsti e revenguts segontes eth sòlde brut. Era linha verticau marque era posicion deth salari introdusit.', breakdownTitle: 'Desglossament de Còsti', taxDistributionTitle: '🏛️ A qué se destinen es tòns impòsti?', taxDestination: 'Destinacion dera Despesa', taxPercentagePGE: '% PGE', taxYourContribution: 'Era tua Aportacion', total: 'Total', taxDisclaimer: 'Nòta: Aguesta taula distribuís eth total d\'impòsti (IRPF + S.S.) segontes es percentatges de despesa des PGE 2023. Ei un modèl illustratiu.', generalDisclaimer: 'Avís Generau: Aguest calcul ei ua estimacion. Es chifres reaus pòden variar segontes convèni, tipe de contracte, situacion personau, etc.', totalCompanyCost: '💰 Còst Totau Empresa', ssCompany: '🏛️ S.S. (Entrepresa)', grossSalary: '💼 Sòlde Brut', irpf: '🏛️ IRPF (Retencion)', ssEmployee: '🏛️ S.S. (Trabalhador)', netSalary: '✅ Sòlde Net', ofTotal: 'deth totau', ofGross: 'deth brut', chartLabelState: 'Recaptat per er\'Estat', chartLabelNet: 'Recebut peth Trabalhador (Net)', chartSeriesCompany: 'Còst Empresa', chartSeriesState: 'Recaptat Estat', chartSeriesNet: 'Sòlde Net', yourSalary: 'Eth Tòn Salari', pensions: 'Pensions', debt: 'Deute Public (interèssi)', transfers: 'Transf. a Adm. Publiques', unemployment: 'Shens trabalh', health: 'Sanitat', education: 'Educacion', publicServices: 'Servicis Publics Generaus', fomento: 'Foment', defense: 'Defensa e Seguretat', industry: 'Indústria e Energia', rdi: 'R+D+i e Digitalizacion', culture: 'Cultura e auti', royalHouse: 'Casa Reiau', comparisonTitle: '🌍 Comparativa Internacionau', sortByCompanyCost: 'Ordenar per Còst Empresa', sortByStateRevenue: 'Ordenar per Impòsti', sortByNetSalary: 'Ordenar per Sòlde Net', comparisonModeReal: 'Anàlisi Reau', comparisonModeHypothesis: 'Anàlisi Ipotetica', comparisonDisclaimerReal: 'Anàlisi Reau: Compare es sistèmes fiscaus en tot aplicar eth tòn sòlde brut a cada país.', comparisonDisclaimerHypothesis: 'Anàlisi Ipotetica: Compaere qué sòlde auries se er\'inversion totau der\'entrepresa ère era madeisha qu\'en Espanha.', comparisonDisclaimerNote: 'Nòta: Modèls fiscaus e de seguretat sociau fòrça simplificadi. Proposit purament illustratiu.', country_es: 'Espanha', country_de: 'Alemanha', country_fr: 'França', country_uk: 'Regne Unit', country_us: 'EUA', country_br: 'Brasil', country_be: 'Belgica', country_it: 'Itàlia', country_se: 'Suècia', country_pt: 'Portugal', country_nl: 'Païsi Baishi', country_ie: 'Irlanda', country_ch: 'Soïssa', country_mx: 'Mexic', country_ar: 'Argentina', country_cl: 'Chile', country_co: 'Colómbia', compChartNet: 'Sòlde Net', compChartStateRevenue: 'Recaptat per er\'Estat'
        }
    };
            
            const formatCurrency = (v) => (typeof v === 'number') ? v.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', useGrouping: true, minimumFractionDigits: 0 }) : '';
            const formatPercent = (v) => (typeof v === 'number') ? `${v.toFixed(2)}%` : '';

            const getIrpfRateSpain = (s) => countryData['ES'].get_irpf(s);
            
            const translateUI = () => {
                const t = fullTranslations[currentLang] || fullTranslations['es'];
                document.querySelectorAll('[data-translate-key]').forEach(el => { const key = el.dataset.translateKey; if (t[key]) el.textContent = t[key]; });
                document.querySelectorAll('[data-translate-placeholder]').forEach(el => { const key = el.dataset.translatePlaceholder; if (t[key]) el.placeholder = t[key]; });
                document.title = t.documentTitle;
            };

            const setLanguage = (lang) => {
                currentLang = lang;
                localStorage.setItem('selectedLanguage', lang);
                document.documentElement.lang = lang;
                translateUI();
                
                if (Object.keys(annualValues).length > 0) {
                    const theme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
                    initCharts(theme);
                    updateDisplay();
                }
            };
            
            const getCssVar = (varName) => getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
            
            const getSummaryChartOptions = (theme) => ({
                series: [], chart: { type: 'donut', height: 300, fontFamily: 'Inter, sans-serif', theme: { mode: theme } },
                labels: [(fullTranslations[currentLang] || fullTranslations.es).chartLabelState, (fullTranslations[currentLang] || fullTranslations.es).chartLabelNet],
                colors: [getCssVar('--state-color'), getCssVar('--employee-color')], legend: { position: 'bottom', labels: { colors: getCssVar('--text-muted') } },
                dataLabels: { enabled: true, formatter: (val, opts) => [val.toFixed(1) + '%', formatCurrency(opts.w.globals.series[opts.seriesIndex])], style: { fontSize: '12px', colors: ['#fff'], fontWeight: 600 }, dropShadow: { enabled: true, top: 1, left: 1, blur: 1, opacity: 0.7 } },
                tooltip: { theme: theme, y: { formatter: (val) => formatCurrency(val) } }
            });

            const getBreakdownChartOptions = (theme) => ({
                series: [{ data: [] }], chart: { type: 'treemap', height: 250, fontFamily: 'Inter, sans-serif', theme: { mode: theme } },
                plotOptions: { treemap: { enableShades: true, shadeIntensity: 0.5, distributed: true } },
                colors: [getCssVar('--state-color'), getCssVar('--state-color'), getCssVar('--state-color'), getCssVar('--employee-color')],
                tooltip: { theme: theme, y: { formatter: (val) => formatCurrency(val) } },
                dataLabels: { enabled: true, style: { fontSize: '12px', fontWeight: '600' }, formatter: (text, op) => [text, formatPercent((op.value / op.w.globals.seriesTotals[0]) * 100), formatCurrency(op.value)], offsetY: -4 }
            });

            const getTaxDistributionChartOptions = (theme) => ({
                series: [{ data: [] }], chart: { type: 'treemap', height: 300, fontFamily: 'Inter, sans-serif', theme: { mode: theme } },
                plotOptions: { treemap: { enableShades: true, shadeIntensity: 0.6, distributed: true } },
                tooltip: { theme: theme, y: { formatter: (val) => formatCurrency(val) } },
                dataLabels: { enabled: true, style: { fontSize: '12px', fontWeight: '600' }, formatter: (text, op) => [text, formatPercent((op.value / op.w.globals.seriesTotals[0]) * 100), formatCurrency(op.value)], offsetY: -4 }
            });

            const getEvolutionChartOptions = (theme) => ({
                series: [], chart: { type: 'line', height: 400, fontFamily: 'Inter, sans-serif', zoom: { enabled: false }, theme: { mode: theme } },
                colors: [getCssVar('--company-color'), getCssVar('--state-color'), getCssVar('--employee-color')],
                stroke: { width: 3, curve: 'smooth' }, markers: { size: 0 },
                xaxis: { type: 'numeric', title: { text: '', style: { color: getCssVar('--text-muted') } }, labels: { style: { colors: getCssVar('--text-muted') }, formatter: (val) => `${(val/1000).toFixed(0)}k €` } },
                yaxis: { title: { text: 'Euros (€)', style: { color: getCssVar('--text-muted') } }, labels: { style: { colors: getCssVar('--text-muted') }, formatter: (val) => `${(val/1000).toFixed(0)}k €` } },
                grid: { borderColor: getCssVar('--border-color') }, legend: { position: 'top', horizontalAlign: 'left', labels: { colors: getCssVar('--text-muted') } },
                annotations: { xaxis: [] },
                tooltip: { theme: theme, x: { formatter: (val) => `${(fullTranslations[currentLang] || fullTranslations.es).grossSalary}: ${formatCurrency(val)}` }, y: { formatter: (val) => formatCurrency(val) } }
            });

            const getComparisonChartOptions = (theme) => ({
                series: [],
                chart: { type: 'bar', fontFamily: 'Inter, sans-serif', theme: { mode: theme } },
                plotOptions: { bar: { horizontal: true } },
                stroke: { width: 1, colors: [ getCssVar('--card-bg') ] },
                xaxis: { labels: { style: { colors: getCssVar('--text-muted') }, formatter: (val) => `${(val/1000).toFixed(0)}k €` } },
                yaxis: { labels: { style: { colors: getCssVar('--text-muted'), fontWeight: 600, fontSize: '14px' } } },
                tooltip: { theme: theme, y: { formatter: function(val) { return formatCurrency(val) } } },
                grid: { borderColor: getCssVar('--border-color') },
                legend: { position: 'top', horizontalAlign: 'left' }
            });
            
            const initCharts = (theme) => {
                Object.values(charts).forEach(chart => chart?.destroy());
                charts.summary = new ApexCharts(document.querySelector("#summary-chart"), getSummaryChartOptions(theme));
                charts.breakdown = new ApexCharts(document.querySelector("#breakdown-chart"), getBreakdownChartOptions(theme));
                charts.taxDistribution = new ApexCharts(document.querySelector("#tax-distribution-chart"), getTaxDistributionChartOptions(theme));
                charts.evolution = new ApexCharts(document.querySelector("#evolution-chart"), getEvolutionChartOptions(theme));
                charts.comparison = new ApexCharts(document.querySelector("#comparison-chart"), getComparisonChartOptions(theme));
                Object.values(charts).forEach(chart => chart.render());
            };

            const updateEvolutionControls = (divisor) => {
                evolutionSmiInput.value = (SMI_ANNUAL / divisor).toFixed(0);
                evolutionMaxInput.value = (evolutionMaxSalaryAnnual / divisor).toFixed(0);
            };

            const generateAndDrawEvolutionChart = () => {
                if (!charts.evolution) return;
                const divisor = periodToggle.checked ? 12 : 1;
                const minSalary = SMI_ANNUAL;
                const maxSalary = evolutionMaxSalaryAnnual;
                const currentSalary = parseFloat(sueldoBrutoInput.value) || 0;
                const step = (maxSalary - minSalary) / 100;
                const t = fullTranslations[currentLang] || fullTranslations['es'];
                const costeData = [], estadoData = [], netoData = [];
                for (let sueldo = minSalary; sueldo <= maxSalary; sueldo += step) {
                    const ssEmpresa = sueldo * countryData['ES'].ss_empresa, costeTotal = sueldo + ssEmpresa, ssTrabajador = sueldo * countryData['ES'].ss_trabajador, irpf = sueldo * getIrpfRateSpain(sueldo), sueldoNeto = sueldo - ssTrabajador - irpf, totalEstado = ssEmpresa + ssTrabajador + irpf;
                    costeData.push({ x: sueldo, y: costeTotal });
                    estadoData.push({ x: sueldo, y: totalEstado });
                    netoData.push({ x: sueldo, y: sueldoNeto });
                }
                charts.evolution.updateOptions({
                    series: [ { name: t.chartSeriesCompany, data: costeData.map(p => ({x: p.x/divisor, y: p.y/divisor})) }, { name: t.chartSeriesState, data: estadoData.map(p => ({x: p.x/divisor, y: p.y/divisor})) }, { name: t.chartSeriesNet, data: netoData.map(p => ({x: p.x/divisor, y: p.y/divisor})) } ],
                    annotations: { xaxis: [{ x: currentSalary / divisor, borderColor: getCssVar('--primary-color'), label: { borderColor: getCssVar('--primary-color'), style: { color: '#fff', background: getCssVar('--primary-color') }, text: t.yourSalary } }] },
                    xaxis: { min: minSalary / divisor, max: maxSalary / divisor, title: { text: `${t.grossSalaryLabel.replace(' (€)', '')} ${divisor === 1 ? '' : '(' + t.monthly + ')'}` } },
                });
            };

            const calculateAndDrawComparison = () => {
                const divisor = periodToggle.checked ? 12 : 1;
                const sueldoBrutoBase = parseFloat(sueldoBrutoInput.value);
                const costeTotalEmpresa_ES = sueldoBrutoBase * (1 + countryData['ES'].ss_empresa);

                comparisonData = Object.entries(countryData).map(([code, data]) => {
                    let sueldoBrutoAnual, costeEmpresa;
                    
                    if (comparisonMode === 'hypothesis' && code !== 'ES') {
                        costeEmpresa = costeTotalEmpresa_ES;
                        sueldoBrutoAnual = costeEmpresa / (1 + data.ss_empresa);
                    } else {
                        sueldoBrutoAnual = sueldoBrutoBase;
                        costeEmpresa = sueldoBrutoAnual * (1 + data.ss_empresa);
                    }

                    const ssTrabajador = sueldoBrutoAnual * data.ss_trabajador;
                    const irpf = sueldoBrutoAnual * data.get_irpf(sueldoBrutoAnual);
                    const sueldoNeto = sueldoBrutoAnual - ssTrabajador - irpf;
                    const impuestosTotales = costeEmpresa - sueldoNeto;

                    return { code, nameKey: `country_${code.toLowerCase()}`, costeEmpresa: costeEmpresa / divisor, impuestosTotales: impuestosTotales / divisor, sueldoNeto: sueldoNeto / divisor };
                });
                sortAndDrawComparisonChart();
            };
            
            const sortAndDrawComparisonChart = () => {
                if (!charts.comparison || comparisonData.length === 0) return;
                comparisonData.sort((a, b) => b[currentSortCriteria] - a[currentSortCriteria]);
                const t = fullTranslations[currentLang] || fullTranslations['es'];
                
                const categories = comparisonData.map((d, i) => `${i + 1}. ${t[d.nameKey] || d.code}`);
                
                let series, colors, legendItems;
                
                if (currentSortCriteria === 'impuestosTotales') {
                    series = [ { name: t.compChartStateRevenue, data: comparisonData.map(d => d.impuestosTotales) }, { name: t.compChartNet, data: comparisonData.map(d => d.sueldoNeto) } ];
                    colors = [getCssVar('--state-color'), getCssVar('--employee-color')];
                    legendItems = [t.compChartStateRevenue, t.compChartNet];
                } else {
                    series = [ { name: t.compChartNet, data: comparisonData.map(d => d.sueldoNeto) }, { name: t.compChartStateRevenue, data: comparisonData.map(d => d.impuestosTotales) } ];
                    colors = [getCssVar('--employee-color'), getCssVar('--state-color')];
                    legendItems = [t.compChartNet, t.compChartStateRevenue];
                }

                charts.comparison.updateOptions({
                    series: series,
                    colors: colors,
                    xaxis: { categories: categories },
                    chart: { height: comparisonData.length * 45 + 80, stacked: true },
                    plotOptions: {
                        bar: {
                            horizontal: true,
                            dataLabels: {
                                total: {
                                    enabled: true,
                                    offsetX: 0,
                                    style: { fontSize: '13px', fontWeight: 900, color: getCssVar('--text-color') },
                                    formatter: (val, opts) => formatCurrency(comparisonData[opts.dataPointIndex].costeEmpresa)
                                }
                            }
                        }
                    },
                    dataLabels: {
                        enabled: true,
                        formatter: function(val, { seriesIndex, dataPointIndex }) {
                            const total = comparisonData[dataPointIndex].costeEmpresa;
                            if (total === 0 || val/total < 0.08) return '';
                            const percentage = (val / total * 100).toFixed(0);
                            return `${formatCurrency(val)} (${percentage}%)`;
                        },
                        style: { colors: ['#fff'], fontWeight: 500 },
                        dropShadow: { enabled: true, top: 1, left: 1, blur: 1, opacity: 0.4 }
                    },
                    legend: { customLegendItems: legendItems }
                });

                document.querySelectorAll('.comparison-controls button').forEach(btn => btn.classList.remove('active'));
                if (currentSortCriteria === 'costeEmpresa') sortCostBtn.classList.add('active');
                else if (currentSortCriteria === 'impuestosTotales') sortTaxBtn.classList.add('active');
                else if (currentSortCriteria === 'sueldoNeto') sortNetBtn.classList.add('active');
            };

            const updateDisplay = () => {
                if (Object.keys(annualValues).length === 0) return;
                const isMonthly = periodToggle.checked;
                const divisor = isMonthly ? 12 : 1;
                const v = annualValues;
                const t = fullTranslations[currentLang] || fullTranslations['es'];
                
                document.getElementById('summary-empresa').textContent = formatCurrency(v.costeTotalEmpresa / divisor);
                document.getElementById('summary-estado').textContent = formatCurrency(v.totalEstado / divisor);
                document.getElementById('summary-trabajador').textContent = formatCurrency(v.sueldoNeto / divisor);
                charts.summary.updateSeries([v.totalEstado, v.sueldoNeto].map(val => val / divisor));
                
                charts.breakdown.updateSeries([{ data: [ { x: t.ssCompany, y: v.ssEmpresa / divisor }, { x: t.irpf, y: v.irpf / divisor }, { x: t.ssEmployee, y: v.ssTrabajador / divisor }, { x: t.netSalary, y: v.sueldoNeto / divisor } ] }]);
                document.getElementById('breakdown-container').innerHTML = `<div class="breakdown-card company-cost"><div class="breakdown-header"><span class="card-info">${t.totalCompanyCost}</span><div class="value-wrapper"><span class="value">${formatCurrency(v.costeTotalEmpresa / divisor)}</span><div class="percentages"><span>${formatPercent(100)}</span></div></div></div><div class="nested-cards"><div class="breakdown-card state-tax"><div class="breakdown-header"><span class="card-info">${t.ssCompany}</span><div class="value-wrapper"><span class="value">${formatCurrency(v.ssEmpresa / divisor)}</span><div class="percentages"><span>${formatPercent(v.perc_ssEmpresa_parent)} ${t.ofTotal}</span></div></div></div></div><div class="breakdown-card employee-gross"><div class="breakdown-header"><span class="card-info">${t.grossSalary}</span><div class="value-wrapper"><span class="value">${formatCurrency(v.sueldoBrutoAnual / divisor)}</span><div class="percentages"><span>${formatPercent(v.perc_bruto_parent)} ${t.ofTotal}</span></div></div></div><div class="nested-cards"><div class="breakdown-card state-tax"><div class="breakdown-header"><span class="card-info">${t.irpf}</span><div class="value-wrapper"><span class="value">${formatCurrency(v.irpf / divisor)}</span><div class="percentages"><span>${formatPercent(v.perc_irpf_parent)} ${t.ofGross}</span></div></div></div></div><div class="breakdown-card state-tax"><div class="breakdown-header"><span class="card-info">${t.ssEmployee}</span><div class="value-wrapper"><span class="value">${formatCurrency(v.ssTrabajador / divisor)}</span><div class="percentages"><span>${formatPercent(v.perc_ssTrabajador_parent)} ${t.ofGross}</span></div></div></div></div><div class="breakdown-card employee-net"><div class="breakdown-header"><span class="card-info">${t.netSalary}</span><div class="value-wrapper"><span class="value">${formatCurrency(v.sueldoNeto / divisor)}</span><div class="percentages"><span>${formatPercent(v.perc_neto_parent)} ${t.ofGross}</span></div></div></div></div></div></div></div>`;
                
                const taxTbody = document.getElementById('tax-tbody');
                taxTbody.innerHTML = '';
                const taxDistributionData = [];
                v.taxDistribution.forEach(item => {
                    const amount = item.annualAmount / divisor;
                    taxTbody.innerHTML += `<tr><td>${t[item.key]}</td><td class="numeric-cell">${formatPercent(item.percent * 100)}</td><td class="numeric-cell">${formatCurrency(amount)}</td></tr>`;
                    taxDistributionData.push({ x: t[item.key] || item.key, y: amount });
                });
                document.getElementById('tax-total').textContent = formatCurrency(v.totalEstado / divisor);
                charts.taxDistribution.updateSeries([{ data: taxDistributionData }]);

                updateEvolutionControls(divisor);
                generateAndDrawEvolutionChart();
                calculateAndDrawComparison();
            };

            const calculate = () => {
                const sueldoBrutoAnual = parseFloat(sueldoBrutoInput.value);
                if (isNaN(sueldoBrutoAnual) || sueldoBrutoAnual <= 0) { alert('Por favor, introduce un sueldo bruto anual válido.'); return; }
                const ssEmpresa = sueldoBrutoAnual * countryData['ES'].ss_empresa, costeTotalEmpresa = sueldoBrutoAnual + ssEmpresa, ssTrabajador = sueldoBrutoAnual * countryData['ES'].ss_trabajador, irpf = sueldoBrutoAnual * getIrpfRateSpain(sueldoBrutoAnual), sueldoNeto = sueldoBrutoAnual - ssTrabajador - irpf, totalEstado = ssEmpresa + ssTrabajador + irpf;
                annualValues = { sueldoBrutoAnual, costeTotalEmpresa, ssEmpresa, ssTrabajador, irpf, sueldoNeto, totalEstado, perc_ssEmpresa_parent: (ssEmpresa / costeTotalEmpresa) * 100, perc_bruto_parent: (sueldoBrutoAnual / costeTotalEmpresa) * 100, perc_irpf_parent: (irpf / sueldoBrutoAnual) * 100, perc_ssTrabajador_parent: (ssTrabajador / sueldoBrutoAnual) * 100, perc_neto_parent: (sueldoNeto / sueldoBrutoAnual) * 100, taxDistribution: PGE_DISTRIBUTION.map(item => ({...item, annualAmount: totalEstado * item.percent })) };
                if (!charts.summary) {
                    const currentTheme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
                    initCharts(currentTheme);
                }
                updateDisplay();
                document.getElementById('results').style.display = 'block';
                window.scrollTo({ top: document.getElementById('results').offsetTop - 20, behavior: 'smooth' });
            };
            
            const applyTheme = (theme) => {
                document.body.classList.toggle('dark-theme', theme === 'dark');
                localStorage.setItem('theme', theme);
                if(charts.summary) {
                    initCharts(theme);
                    if (Object.keys(annualValues).length > 0) updateDisplay();
                }
            };
            
            // --- INITIALIZATION & EVENT LISTENERS ---
            const initialLang = localStorage.getItem('selectedLanguage') || 'es';
            langSelector.value = initialLang; 
            setLanguage(initialLang);
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            themeToggle.checked = savedTheme === 'dark'; 
            applyTheme(savedTheme);
            calculateBtn.addEventListener('click', calculate);
            sueldoBrutoInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') calculate(); });
            periodToggle.addEventListener('change', updateDisplay);
            themeToggle.addEventListener('change', () => applyTheme(themeToggle.checked ? 'dark' : 'light'));
            langSelector.addEventListener('change', (e) => setLanguage(e.target.value));
            redrawEvolutionBtn.addEventListener('click', () => { evolutionMaxSalaryAnnual = parseFloat(evolutionMaxInput.value) * (periodToggle.checked ? 12 : 1); generateAndDrawEvolutionChart(); });
            sortCostBtn.addEventListener('click', () => { currentSortCriteria = 'costeEmpresa'; sortAndDrawComparisonChart(); });
            sortTaxBtn.addEventListener('click', () => { currentSortCriteria = 'impuestosTotales'; sortAndDrawComparisonChart(); });
            sortNetBtn.addEventListener('click', () => { currentSortCriteria = 'sueldoNeto'; sortAndDrawComparisonChart(); });

            modeRealBtn.addEventListener('click', () => {
                comparisonMode = 'real';
                modeRealBtn.classList.add('active');
                modeHypothesisBtn.classList.remove('active');
                const t = fullTranslations[currentLang] || fullTranslations['es'];
                comparisonModeDescription.textContent = t.comparisonDisclaimerReal;
                if (Object.keys(annualValues).length > 0) calculateAndDrawComparison();
            });
            modeHypothesisBtn.addEventListener('click', () => {
                comparisonMode = 'hypothesis';
                modeHypothesisBtn.classList.add('active');
                modeRealBtn.classList.remove('active');
                const t = fullTranslations[currentLang] || fullTranslations['es'];
                comparisonModeDescription.textContent = t.comparisonDisclaimerHypothesis;
                if (Object.keys(annualValues).length > 0) calculateAndDrawComparison();
            });
        });
    </script>
</body>
</html>