<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="documentTitle">Dashboard Salarial</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --primary-hover: #0069d9;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #212529;
            --text-muted: #6c757d;
            --border-color: #e9ecef;
            --state-color: #fd7e14;
            --company-color: #dc3545;
            --employee-color: #198754;
            --extra-pay-color: #20c997;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.1);
        }
        body.dark-theme {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --text-muted: #888;
            --border-color: #2c2c2c;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.4);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 2rem 1rem;
            display: flex;
            justify-content: center;
            transition: background-color 0.3s, color 0.3s;
        }
        main {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 1400px;
            transition: background-color 0.3s;
        }
        @media (min-width: 768px) {
            main {
                padding: 2.5rem;
            }
        }
        .header-container { text-align: center; margin-bottom: 2rem; }
        h1 { font-size: 2.25rem; margin: 0; }
        .top-controls { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1rem; flex-wrap: wrap; }
        .author-credit { display: flex; align-items: center; gap: 0.5rem; flex-grow: 1; justify-content: center; }
        .author-credit a { color: var(--text-muted); text-decoration: none; font-weight: 500; transition: color 0.2s; }
        .author-credit a:hover { color: var(--primary-color); }
        .author-credit svg { width: 16px; height: 16px; fill: currentColor; }
        h2 { text-align: center; font-weight: 700; font-size: 1.75rem; margin-top: 2rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        
        #lang-selector { background-color: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.25rem 0.5rem; font-family: 'Inter', sans-serif; font-weight: 500;}
        .control-switch-wrapper { display: flex; align-items: center; gap: 0.5rem; font-weight: 500; }
        .control-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .control-switch input { opacity: 0; width: 0; height: 0; }
        .control-slider { position: absolute; cursor: pointer; inset: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .control-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        .control-slider-icon { position: absolute; top: 50%; transform: translateY(-50%); font-size: 12px; font-weight: bold; color: var(--bg-color); user-select: none; }
        .icon-on { right: 7px; opacity: 1; transition: opacity 0.4s; }
        .icon-off { left: 7px; opacity: 0; transition: opacity 0.4s; }
        input:checked + .control-slider { background-color: var(--primary-color); }
        input:checked + .control-slider:before { transform: translateX(20px); }
        input:checked + .control-slider .icon-on { opacity: 0; }
        input:checked + .control-slider .icon-off { opacity: 1; }

        .input-section-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .main-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .main-input-group label {
            font-weight: 600;
            font-size: 1.1rem;
        }
        #sueldo-bruto {
            font-size: 1.8rem;
            font-weight: 700;
            padding: 0.9rem;
            width: 100%;
            box-sizing: border-box;
            text-align: right;
        }
        .primary-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 700;
        }
        .primary-button:hover { background-color: var(--primary-hover); }
        #calculate-btn {
            width: 100%;
            padding: 1rem;
            font-size: 1.2rem;
            margin-top: 1rem;
        }

        .advanced-settings {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.3s;
            overflow: hidden;
        }
        .advanced-settings summary {
            padding: 0.75rem 1rem;
            font-weight: 600;
            cursor: pointer;
            list-style: none;
            display: flex;
            align-items: center;
        }
        .advanced-settings summary::-webkit-details-marker { display: none; }
        .advanced-settings summary::before {
            content: '‚ñ∂';
            margin-right: 0.5rem;
            font-size: 0.8em;
            display: inline-block;
            transition: transform 0.2s;
        }
        .advanced-settings[open] { background-color: var(--bg-color); }
        .advanced-settings[open] > summary::before { transform: rotate(90deg); }
        .advanced-form-panel { padding: 0 1.5rem 1.5rem 1.5rem; }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        @media (min-width: 768px) {
            .form-grid {
                grid-template-columns: minmax(250px, 1fr) 2fr;
                align-items: center;
                gap: 0.75rem 1.5rem;
            }
        }
        .advanced-section-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        .nested-details > summary.advanced-section-title::before, .nested-details[open] > summary.advanced-section-title::before { transform: none; content: " "; margin-right: 0;}
        .form-grid label { font-weight: 500; font-size: 0.95rem; }
        .form-grid input[type="number"], .form-grid select {
            background-color: var(--card-bg); color: var(--text-color); width: 100%; padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; box-sizing: border-box; transition: all 0.2s;
        }
        .form-grid input[type="number"]:focus, .form-grid select:focus {
            border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); outline: none;
        }
        .nested-details { margin-top: 1rem; }
        .nested-details > summary { cursor: pointer; list-style: none; display: flex; align-items: center; }
        .nested-details > summary::-webkit-details-marker { display: none; }
        .nested-details > summary::before { content: '‚ñæ'; margin-right: 0.5rem; display: inline-block; transition: transform 0.2s; font-size: 1.2em; font-weight: bold; }
        .nested-details:not([open]) > summary::before { transform: rotate(-90deg); }
        .nested-details .form-grid { padding-left: 1.5rem; }

        input[type="number"] { background-color: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 8px; transition: all 0.2s; }
        #results { display: none; }
        .results-header { display: flex; justify-content: center; margin-bottom: 1.5rem; }
        .disclaimer { font-size: 0.8rem; color: var(--text-muted); background-color: var(--bg-color); border-radius: 8px; padding: 0.75rem; margin-top: 1.5rem; line-height: 1.5; }
        .summary-section { display: flex; flex-wrap: wrap; gap: 2rem; align-items: center; }
        .summary-grid { flex: 1 1 300px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .summary-chart-container { flex: 1 1 250px; min-width: 250px; }
        .summary-card { background-color: var(--card-bg); padding: 1.25rem; border-radius: 12px; display: flex; flex-direction: column; justify-content: space-between; gap: 0.5rem; box-shadow: var(--shadow-md); transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; }
        .summary-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .summary-card .label { font-weight: 600; font-size: 1rem; }
        .summary-card .value { font-size: 1.75rem; font-weight: 700; font-family: monospace; white-space: nowrap; align-self: flex-end; margin-top: 0.5rem; }
        .summary-card.company .value { color: var(--company-color); }
        .summary-card.state .value { color: var(--state-color); }
        .summary-card.employee .value { color: var(--employee-color); }
        .summary-card.extra-pay .value { color: var(--extra-pay-color); }
        #summary-extra-pay-card { display: none; }
        .breakdown-card { border-radius: 12px; background-color: var(--card-bg); margin-top: 1rem; box-shadow: var(--shadow-sm); overflow: hidden; transition: background-color 0.3s; }
        .breakdown-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.25rem; }
        .card-info { font-weight: 600; font-size: 1.1rem; }
        .value-wrapper { display: flex; flex-direction: column; align-items: flex-end; }
        .breakdown-header .value { font-family: monospace; font-size: 1.5rem; font-weight: 700; white-space: nowrap; }
        .breakdown-header .percentages { font-size: 0.85rem; color: var(--text-muted); margin-top: 4px; }
        .nested-cards { padding: 0 1rem 1rem 1rem; background-color: rgba(0,0,0,0.02); border-top: 1px solid var(--border-color); }
        body.dark-theme .nested-cards { background-color: rgba(255,255,255,0.03); }
        .company-cost { border-left: 4px solid var(--company-color); }
        .state-tax { border-left: 4px solid var(--state-color); }
        .employee-gross { border-left: 4px solid var(--text-color); }
        .employee-net { border-left: 4px solid var(--employee-color); }
        .tax-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .tax-table th, .tax-table td { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); text-align: left; transition: background-color 0.3s; }
        .tax-table thead th { font-weight: 600; color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase; }
        .tax-table .numeric-cell { text-align: right; font-family: monospace; }
        .tax-table tbody tr:hover td { background-color: var(--bg-color); }
        .tax-table tfoot td { font-weight: 700; border-top: 2px solid var(--text-color); }
        .evolution-controls { display: flex; align-items: flex-end; gap: 1rem; margin-top: 1rem; flex-wrap: wrap; }
        .evolution-controls .input-wrapper { display: flex; flex-direction: column; gap: 0.25rem; }
        .evolution-controls .input-container { display: flex; align-items: center; gap: 0.5rem; }
        .evolution-controls input { text-align: right; width: 120px; }
        .evolution-controls button {
             padding: 0.5rem 1rem; font-size: 0.9rem; height: fit-content;
        }

        .comparison-controls-container { display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .comparison-controls, .comparison-mode-controls { display: flex; justify-content: center; gap: 0.5rem; flex-wrap: wrap; }
        .comparison-controls button, .comparison-mode-controls button { font-size: 0.9rem; padding: 0.5rem 1rem; background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 8px; }
        .comparison-controls button.active, .comparison-mode-controls button.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); font-weight: 600; }
        #comparison-mode-description {
            text-align: center;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }

        .dashboard-grid {
            display: grid;
            gap: 2.5rem;
            align-items: flex-start;
        }
        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }
            #summary-section { grid-column: 1 / 2; grid-row: 1 / 2; }
            #evolution-section { grid-column: 2 / 3; grid-row: 1 / 2; }
            #breakdown-section { grid-column: 1 / 2; grid-row: 2 / 3; }
            #tax-distribution-section { grid-column: 2 / 3; grid-row: 2 / 3; }
            #comparison-section { grid-column: 1 / -1; grid-row: 3 / 4; }
        }
    </style>
</head>
<body>
    <main>
        <div class="header-container">
            <h1 data-translate-key="pageTitle"></h1>
            <div class="top-controls">
                <div class="author-credit"><span data-translate-key="authorBy"></span><a href="https://www.linkedin.com/in/oriol-badia" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24" aria-hidden="true"><g><path d="M20.5 2h-17A1.5 1.5 0 002 3.5v17A1.5 1.5 0 003.5 22h17a1.5 1.5 0 001.5-1.5v-17A1.5 1.5 0 0020.5 2zM8 19H5v-9h3zM6.5 8.25A1.75 1.75 0 114.75 6.5 1.75 1.75 0 016.5 8.25zM19 19h-3v-4.75c0-1.4-1.2-2.5-2.5-2.5S11 12.85 11 14.25V19h-3v-9h2.9v1.3a3.11 3.11 0 012.6-1.4c2.5 0 4.5 2.1 4.5 5.1V19z"></path></g></svg><span>Oriol Badia Campanera</span></a></div>
                <select id="lang-selector">
                    <option value="es">Castellano</option><option value="ca">Catal√†</option><option value="eu">Euskara</option><option value="gl">Galego</option><option value="oc">Aran√©s</option><option value="en">English</option>
                </select>
                <div class="control-switch-wrapper"><label class="control-switch"><input type="checkbox" id="theme-toggle"><span class="control-slider"><span class="control-slider-icon icon-on">‚òÄÔ∏è</span><span class="control-slider-icon icon-off">üåô</span></span></label></div>
            </div>
        </div>
        
        <div class="input-section-container">
            <div class="main-input-group">
                <label for="sueldo-bruto" data-translate-key="grossSalaryLabel"></label>
                <input type="number" id="sueldo-bruto" value="30000" data-translate-placeholder="grossSalaryPlaceholder" min="0">
            </div>
        
            <details class="advanced-settings">
                <summary data-translate-key="advancedOptions"></summary>
                <div class="advanced-form-panel">
                    <h3 class="advanced-section-title" data-translate-key="sectionTitleGeneral"></h3>
                    <div class="form-grid">
                        <label for="comunidad-autonoma" data-translate-key="labelAutonomousCommunity"></label>
                        <select id="comunidad-autonoma">
                            <option value="comun">Territorio Com√∫n (predeterminada)</option>
                            <option value="andalucia">Andaluc√≠a</option>
                            <option value="aragon">Arag√≥n</option>
                            <option value="asturias">Asturias</option>
                            <option value="baleares">Baleares</option>
                            <option value="canarias">Canarias</option>
                            <option value="cantabria">Cantabria</option>
                            <option value="castilla_mancha">Castilla-La Mancha</option>
                            <option value="castilla_leon">Castilla y Le√≥n</option>
                            <option value="catalunya">Catalu√±a</option>
                            <option value="extremadura">Extremadura</option>
                            <option value="galicia">Galicia</option>
                            <option value="madrid">Madrid</option>
                            <option value="murcia">Murcia</option>
                            <option value="rioja">La Rioja</option>
                            <option value="valencia">Comunidad Valenciana</option>
                            <option disabled>--- Reg√≠menes Forales no incluidos ---</option>
                        </select>
        
                        <label for="situacion-familiar" data-translate-key="labelFamilySituation"></label>
                        <select id="situacion-familiar">
                            <option value="soltero" data-translate-key="optSingle"></option>
                            <option value="casado1" data-translate-key="optMarried1"></option>
                            <option value="casado2" data-translate-key="optMarried2"></option>
                        </select>
        
                        <label for="edad" data-translate-key="labelAge"></label>
                        <input type="number" id="edad" value="30" min="16">

                        <label for="numero-pagas" data-translate-key="labelNumberOfPays"></label>
                        <input type="number" id="numero-pagas" value="12" min="12" max="18">
                    </div>
        
                    <details class="nested-details" open>
                        <summary class="advanced-section-title" data-translate-key="sectionTitleFamily"></summary>
                        <div class="form-grid">
                            <label for="hijos-menores-25" data-translate-key="labelChildrenUnder25"></label>
                            <input type="number" id="hijos-menores-25" value="0" min="0">
        
                            <label for="hijos-menores-3" data-translate-key="labelChildrenUnder3"></label>
                            <input type="number" id="hijos-menores-3" value="0" min="0">
                            
                            <label for="ascendientes-mayores-65" data-translate-key="labelAscendantsOver65"></label>
                            <input type="number" id="ascendientes-mayores-65" value="0" min="0">
                            
                            <label for="ascendientes-mayores-75" data-translate-key="labelAscendantsOver75"></label>
                            <input type="number" id="ascendientes-mayores-75" value="0" min="0">
                        </div>
                    </details>
        
                    <details class="nested-details" open>
                        <summary class="advanced-section-title" data-translate-key="sectionTitleDisability"></summary>
                        <div class="form-grid">
                            <label for="discapacidad-contribuyente" data-translate-key="labelDisabilityTaxpayer"></label>
                            <select id="discapacidad-contribuyente">
                                <option value="0" data-translate-key="optDisabilityNone"></option>
                                <option value="33" data-translate-key="optDisability33"></option>
                                <option value="65" data-translate-key="optDisability65"></option>
                            </select>
                            
                            <label for="desc-discapacidad-33-65" data-translate-key="labelDescDisability33_65"></label>
                            <input type="number" id="desc-discapacidad-33-65" value="0" min="0">

                            <label for="desc-discapacidad-65" data-translate-key="labelDescDisabilityOver65"></label>
                            <input type="number" id="desc-discapacidad-65" value="0" min="0">
                            
                            <label for="asc-discapacidad-33-65" data-translate-key="labelAscDisability33_65"></label>
                            <input type="number" id="asc-discapacidad-33-65" value="0" min="0">

                            <label for="asc-discapacidad-65" data-translate-key="labelAscDisabilityOver65"></label>
                            <input type="number" id="asc-discapacidad-65" value="0" min="0">
                        </div>
                    </details>
                </div>
            </details>
            <button id="calculate-btn" class="primary-button" data-translate-key="calculateBtn"></button>
        </div>
        
        <div id="results">
            <div class="results-header">
                <div class="control-switch-wrapper">
                    <span data-translate-key="annual"></span>
                    <label class="control-switch"><input type="checkbox" id="period-toggle"><span class="control-slider"><span class="control-slider-icon icon-on">A</span><span class="control-slider-icon icon-off">M</span></span></label>
                    <span data-translate-key="monthly"></span>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <div id="summary-section">
                    <h2 data-translate-key="summaryTitle"></h2>
                    <div class="summary-grid">
                        <div class="summary-card company"><div class="summary-content"><span class="label" data-translate-key="companyInvests"></span></div><span class="value" id="summary-empresa"></span></div>
                        <div class="summary-card state"><div class="summary-content"><span class="label" data-translate-key="stateCollects"></span></div><span class="value" id="summary-estado"></span></div>
                        <div class="summary-card employee"><div class="summary-content"><span class="label" data-translate-key="employeeReceives"></span></div><span class="value" id="summary-trabajador"></span></div>
                        <div class="summary-card extra-pay" id="summary-extra-pay-card"><div class="summary-content"><span class="label" id="summary-extra-pay-label" data-translate-key="extraNetPay"></span></div><span class="value" id="summary-extra-pay-value"></span></div>
                    </div>
                     <div class="summary-chart-container">
                        <div id="summary-chart"></div>
                    </div>
                </div>
                
                <div id="evolution-section">
                    <h2 data-translate-key="evolutionTitle"></h2>
                    <div class="evolution-controls">
                        <div class="input-wrapper"><label for="evolution-smi" data-translate-key="fromSMI"></label><div class="input-container"><input type="number" id="evolution-smi" readonly><span>‚Ç¨</span></div></div>
                        <div class="input-wrapper"><label for="evolution-max-salary" data-translate-key="upTo"></label><div class="input-container"><input type="number" id="evolution-max-salary"><span>‚Ç¨</span></div></div>
                        <button id="redraw-evolution-btn" class="primary-button" data-translate-key="updateChartBtn"></button>
                    </div>
                    <div id="evolution-chart"></div>
                    <p class="disclaimer" data-translate-key="evolutionDisclaimer"></p>
                </div>

                <div id="breakdown-section">
                    <h2 data-translate-key="breakdownTitle"></h2>
                    <div id="breakdown-chart"></div>
                    <div id="breakdown-container"></div>
                </div>

                <div id="tax-distribution-section">
                    <h2 data-translate-key="taxDistributionTitle"></h2>
                    <div id="tax-distribution-chart"></div>
                    <table class="tax-table">
                        <thead><tr><th data-translate-key="taxDestination"></th><th class="numeric-cell" data-translate-key="taxPercentagePGE"></th><th class="numeric-cell" data-translate-key="taxYourContribution"></th></tr></thead>
                        <tbody id="tax-tbody"></tbody>
                        <tfoot><tr><td data-translate-key="total"></td><td></td><td class="numeric-cell" id="tax-total"></td></tr></tfoot>
                    </table>
                    <p class="disclaimer" data-translate-key="taxDisclaimer"></p>
                </div>

                <div id="comparison-section">
                    <h2 data-translate-key="comparisonTitle"></h2>
                    <div class="comparison-controls-container">
                        <div class="comparison-mode-controls">
                            <button id="mode-real-btn" class="active" data-translate-key="comparisonModeReal"></button>
                            <button id="mode-hypothesis-btn" data-translate-key="comparisonModeHypothesis"></button>
                        </div>
                        <div class="comparison-controls">
                            <button id="sort-by-cost" class="active" data-translate-key="sortByCompanyCost"></button>
                            <button id="sort-by-tax" data-translate-key="sortByStateRevenue"></button>
                            <button id="sort-by-net" data-translate-key="sortByNetSalary"></button>
                        </div>
                    </div>
                    <p id="comparison-mode-description" data-translate-key="comparisonDisclaimerReal"></p>
                    <div id="comparison-chart"></div>
                    <p class="disclaimer" data-translate-key="comparisonDisclaimerNote"></p>
                </div>
            </div>
            
            <p class="disclaimer" data-translate-key="generalDisclaimer"></p>
        </div>
    </main>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // UI ELEMENTS
            const calculateBtn = document.getElementById('calculate-btn');
            const sueldoBrutoInput = document.getElementById('sueldo-bruto');
            const periodToggle = document.getElementById('period-toggle');
            const themeToggle = document.getElementById('theme-toggle');
            const langSelector = document.getElementById('lang-selector');
            const redrawEvolutionBtn = document.getElementById('redraw-evolution-btn');
            const evolutionSmiInput = document.getElementById('evolution-smi');
            const evolutionMaxInput = document.getElementById('evolution-max-salary');
            const sortCostBtn = document.getElementById('sort-by-cost');
            const sortTaxBtn = document.getElementById('sort-by-tax');
            const sortNetBtn = document.getElementById('sort-by-net');
            const modeRealBtn = document.getElementById('mode-real-btn');
            const modeHypothesisBtn = document.getElementById('mode-hypothesis-btn');
            const comparisonModeDescription = document.getElementById('comparison-mode-description');
            
            // STATE & CONSTANTS
            let annualValues = {};
            let comparisonData = [];
            let currentSortCriteria = 'costeEmpresa';
            let comparisonMode = 'real';
            let evolutionMaxSalaryAnnual = 100000;
            let charts = { summary: null, breakdown: null, evolution: null, comparison: null, taxDistribution: null };
            let currentLang = 'es';

            const SMI_ANNUAL = 15876;
            const PGE_DISTRIBUTION = [ { key: 'pensions', percent: 0.389 }, { key: 'debt', percent: 0.115 }, { key: 'transfers', percent: 0.101 }, { key: 'unemployment', percent: 0.076 }, { key: 'health', percent: 0.061 }, { key: 'education', percent: 0.052 }, { key: 'publicServices', percent: 0.045 }, { key: 'fomento', percent: 0.041 }, { key: 'defense', percent: 0.038 }, { key: 'industry', percent: 0.031 }, { key: 'rdi', percent: 0.025 }, { key: 'culture', percent: 0.025 }, { key: 'royalHouse', percent: 0.001 }];
            
            const countryData = {
                'FR': { nameKey: 'country_fr', ss_empresa: 0.45, ss_trabajador: 0.22, get_irpf: (s) => { if (s <= 11294) return 0; if (s <= 28797) return 0.11; if (s <= 82341) return 0.30; return 0.41; } },
                'BE': { nameKey: 'country_be', ss_empresa: 0.25, ss_trabajador: 0.1307, get_irpf: (s) => { if (s <= 15200) return 0.25; if (s <= 26830) return 0.40; if (s <= 46440) return 0.45; return 0.50; } },
                'IT': { nameKey: 'country_it', ss_empresa: 0.30, ss_trabajador: 0.0919, get_irpf: (s) => { if (s <= 15000) return 0.23; if (s <= 28000) return 0.25; if (s <= 50000) return 0.35; return 0.43; } },
                'SE': { nameKey: 'country_se', ss_empresa: 0.3142, ss_trabajador: 0.07, get_irpf: (s) => 0.32 },
                'DE': { nameKey: 'country_de', ss_empresa: 0.195, ss_trabajador: 0.205, get_irpf: (s) => { if (s <= 11604) return 0; if (s <= 66760) return 0.28; return 0.42; } },
                'ES': { nameKey: 'country_es', ss_empresa: 0.32, ss_trabajador: 0.0645, get_irpf: (s) => 0 },
                'PT': { nameKey: 'country_pt', ss_empresa: 0.2375, ss_trabajador: 0.11, get_irpf: (s) => { if (s <= 7703) return 0.145; if (s <= 11623) return 0.21; if (s <= 21321) return 0.26; return 0.35; } },
                'NL': { nameKey: 'country_nl', ss_empresa: 0.18, ss_trabajador: 0.2765, get_irpf: (s) => { if (s <= 73031) return 0.3693; return 0.495; } },
                'UK': { nameKey: 'country_uk', ss_empresa: 0.138, ss_trabajador: 0.12, get_irpf: (s) => { const s_gbp = s * 0.85; if (s_gbp <= 12570) return 0; if (s_gbp <= 50270) return 0.20; return 0.40; } },
                'IE': { nameKey: 'country_ie', ss_empresa: 0.1105, ss_trabajador: 0.04, get_irpf: (s) => { if (s <= 40000) return 0.20; return 0.40; } },
                'CH': { nameKey: 'country_ch', ss_empresa: 0.065, ss_trabajador: 0.065, get_irpf: (s) => 0.11 },
                'US': { nameKey: 'country_us', ss_empresa: 0.0765, ss_trabajador: 0.0765, get_irpf: (s) => { const s_usd = s * 1.1; if (s_usd <= 11000) return 0.10; if (s_usd <= 44725) return 0.12; if (s_usd <= 95375) return 0.22; return 0.24; } },
            };
            
            const fullTranslations = {
                en: {
                    documentTitle: 'Salary Dashboard', pageTitle: 'Salary Dashboard', authorBy: 'by',
                    grossSalaryLabel: 'Annual Gross Salary (‚Ç¨)', grossSalaryPlaceholder: 'e.g., 30000', calculateBtn: 'Generate Dashboard',
                    annual: 'Annual', monthly: 'Monthly', summaryTitle: 'Financial Summary',
                    companyInvests: 'Company Cost', stateCollects: 'Collected by State', employeeReceives: 'Monthly Net Salary', netSalaryAnnual: 'Annual Net Salary', extraNetPay: 'Net Extra Pay',
                    extraPaysOf: '{num} extra pays of',
                    evolutionTitle: 'üìà Salary Evolution', fromSMI: 'From (SMI)', upTo: 'Up to', updateChartBtn: 'Update Chart', evolutionDisclaimer: 'This chart shows the exact evolution of costs and income based on the advanced data entered. The vertical line marks your salary.',
                    breakdownTitle: 'Cost Breakdown', taxDistributionTitle: 'üèõÔ∏è Where Your Taxes Go',
                    taxDestination: 'Spending Destination', taxPercentagePGE: '% Budget', taxYourContribution: 'Your Contribution', total: 'Total',
                    taxDisclaimer: 'Note: This table distributes total taxes (IRPF + SS) according to the 2023 Spanish National Budget spending percentages. It is an illustrative model.',
                    generalDisclaimer: 'General Disclaimer: This is a detailed estimate based on 2023 regulations. Actual figures may vary due to collective agreements, specific regional deductions not covered, and other personal circumstances. It does not replace professional advice.',
                    totalCompanyCost: 'üí∞ Total Company Cost', ssCompany: 'üèõÔ∏è SS (Company)', grossSalary: 'üíº Gross Salary', irpf: 'üèõÔ∏è IRPF (Withholding)', ssEmployee: 'üèõÔ∏è SS (Employee)', netSalary: '‚úÖ Net Salary',
                    ofTotal: 'of total', ofGross: 'of gross',
                    chartLabelState: 'Collected by State', chartLabelNet: 'Received by Employee (Net)',
                    chartSeriesCompany: 'Company Cost', chartSeriesState: 'State Revenue', chartSeriesNet: 'Net Salary',
                    yourSalary: 'Your Salary',
                    pensions: 'Pensions', debt: 'Public Debt (interest)', transfers: 'Transfers to Public Admins', unemployment: 'Unemployment', health: 'Healthcare', education: 'Education', publicServices: 'General Public Services', fomento: 'Development', defense: 'Defense & Security', industry: 'Industry & Energy', rdi: 'R&D & Digitization', culture: 'Culture & Others', royalHouse: 'Royal Household',
                    comparisonTitle: 'üåç International Comparison', sortByCompanyCost: 'Sort by Company Cost', sortByStateRevenue: 'Sort by Taxes', sortByNetSalary: 'Sort by Net Salary',
                    comparisonModeReal: 'Real Analysis', comparisonModeHypothesis: 'Hypothetical Analysis',
                    comparisonDisclaimerReal: 'Real Analysis: compare tax systems applying your gross salary to each country.',
                    comparisonDisclaimerHypothesis: 'Hypothetical Analysis: what salary you would have if company investment matched Spain‚Äôs.',
                    comparisonDisclaimerNote: 'Note: Very simplified tax and social security models. Purely for illustrative purposes.',
                    compChartNet: 'Net Salary', compChartStateRevenue: 'Collected by State',
                    advancedOptions: 'Advanced Options (Precise IRPF Calculation)',
                    sectionTitleGeneral: 'GENERAL DATA AND EMPLOYMENT SITUATION',
                    labelAutonomousCommunity: 'Autonomous Community', labelFamilySituation: 'Family Status',
                    optSingle: 'Single, widowed, divorced or legally separated', optMarried1: 'Married and not legally separated (individual tax return)', optMarried2: 'Married and not legally separated (spouse with income < ‚Ç¨1,500)',
                    labelAge: 'Age', labelNumberOfPays: 'Number of pays',
                    sectionTitleFamily: 'FAMILY DATA (Descendants and Ascendants)',
                    labelChildrenUnder25: 'Number of cohabiting children (<25 years or disabled)', labelChildrenUnder3: 'Of those children, how many are under 3?',
                    labelAscendantsOver65: 'No. of cohabiting ascendants >65 with income < ‚Ç¨8,000', labelAscendantsOver75: 'Of those ascendants, how many are over 75?',
                    sectionTitleDisability: 'DISABILITY DATA',
                    labelDisabilityTaxpayer: "Taxpayer's degree of disability",
                    optDisabilityNone: 'No disability', optDisability33: 'Between 33% and 65%', optDisability65: 'Over 65% or reduced mobility',
                    labelDescDisability33_65: 'No. of descendants with 33-65% disability', labelDescDisabilityOver65: 'No. of descendants with >65% disability',
                    labelAscDisability33_65: 'No. of ascendants with 33-65% disability', labelAscDisabilityOver65: 'No. of ascendants with >65% disability',
                    country_es: 'Spain', country_de: 'Germany', country_fr: 'France', country_uk: 'United Kingdom', country_us: 'USA', country_be: 'Belgium', country_it: 'Italy', country_se: 'Sweden', country_pt: 'Portugal', country_nl: 'Netherlands', country_ie: 'Ireland', country_ch: 'Switzerland'
                },
                es: {
                    documentTitle: 'Dashboard Salarial', pageTitle: 'Dashboard Salarial', authorBy: 'por',
                    grossSalaryLabel: 'Sueldo Bruto Anual (‚Ç¨)', grossSalaryPlaceholder: 'Ej: 30000', calculateBtn: 'Generar Dashboard',
                    annual: 'Anual', monthly: 'Mensual', summaryTitle: 'Resumen Financiero',
                    companyInvests: 'Coste Empresa', stateCollects: 'Recaudado por Estado', employeeReceives: 'Sueldo Neto Mensual', netSalaryAnnual: 'Sueldo Neto Anual', extraNetPay: 'Paga Extra Neta',
                    extraPaysOf: '{num} pagas extra de',
                    evolutionTitle: 'üìà Evoluci√≥n Salarial', fromSMI: 'Desde (SMI)', upTo: 'Hasta', updateChartBtn: 'Actualizar', evolutionDisclaimer: 'Este gr√°fico muestra la evoluci√≥n exacta de los costes e ingresos seg√∫n los datos avanzados introducidos. La l√≠nea vertical marca su salario.',
                    breakdownTitle: 'Desglose de Costes', taxDistributionTitle: 'üèõÔ∏è ¬øA qu√© se destinan tus impuestos?',
                    taxDestination: 'Destino del Gasto', taxPercentagePGE: '% PGE', taxYourContribution: 'Tu Aportaci√≥n', total: 'Total',
                    taxDisclaimer: 'Nota: Esta tabla distribuye el total de impuestos (IRPF + S.S.) seg√∫n los porcentajes de gasto de los PGE 2023. Es un modelo ilustrativo.',
                    generalDisclaimer: 'Aviso General: Este c√°lculo es una estimaci√≥n detallada basada en la normativa de 2023. Las cifras reales pueden variar por convenios colectivos, deducciones auton√≥micas espec√≠ficas no contempladas y otras circunstancias personales. No sustituye el consejo de un profesional.',
                    totalCompanyCost: 'üí∞ Coste Total Empresa', ssCompany: 'üèõÔ∏è S.S. (Empresa)', grossSalary: 'üíº Sueldo Bruto', irpf: 'üèõÔ∏è IRPF (Retenci√≥n)', ssEmployee: 'üèõÔ∏è S.S. (Trabajador)', netSalary: '‚úÖ Sueldo Neto',
                    ofTotal: 'del total', ofGross: 'del bruto',
                    chartLabelState: 'Recaudado por el Estado', chartLabelNet: 'Recibido por el Trabajador (Neto)',
                    chartSeriesCompany: 'Coste Empresa', chartSeriesState: 'Recaudado Estado', chartSeriesNet: 'Sueldo Neto',
                    yourSalary: 'Tu Salario',
                    pensions: 'Pensiones', debt: 'Deuda P√∫blica (intereses)', transfers: 'Transf. a Adm. P√∫blicas', unemployment: 'Desempleo', health: 'Sanidad', education: 'Educaci√≥n', publicServices: 'Servicios P√∫blicos Generales', fomento: 'Fomento', defense: 'Defensa y Seguridad', industry: 'Industria y Energ√≠a', rdi: 'I+D+i y Digitalizaci√≥n', culture: 'Cultura y otros', royalHouse: 'Casa Real',
                    comparisonTitle: 'üåç Comparativa Internacional', sortByCompanyCost: 'Ordenar por Coste Empresa', sortByStateRevenue: 'Ordenar por Impuestos', sortByNetSalary: 'Ordenar por Sueldo Neto',
                    comparisonModeReal: 'An√°lisis Real', comparisonModeHypothesis: 'An√°lisis Hipot√©tico',
                    comparisonDisclaimerReal: 'An√°lisis Real: Compara los sistemas fiscales aplicando tu sueldo bruto a cada pa√≠s.',
                    comparisonDisclaimerHypothesis: 'An√°lisis Hipot√©tico: Compara qu√© sueldo tendr√≠as si la inversi√≥n total de la empresa fuera la misma que en Espa√±a.',
                    comparisonDisclaimerNote: 'Nota: Modelos fiscales y de seguridad social muy simplificados. Prop√≥sito puramente ilustrativo.',
                    compChartNet: 'Sueldo Neto', compChartStateRevenue: 'Recaudado por Estado',
                    advancedOptions: 'Opciones Avanzadas (C√°lculo Preciso IRPF)',
                    sectionTitleGeneral: 'DATOS GENERALES Y SITUACI√ìN LABORAL',
                    labelAutonomousCommunity: 'Comunidad Aut√≥noma', labelFamilySituation: 'Situaci√≥n familiar',
                    optSingle: 'Soltero, viudo, divorciado o separado legalmente', optMarried1: 'Casado y no separado legalmente (declaraci√≥n individual)', optMarried2: 'Casado y no separado legalmente (c√≥nyuge con rentas < 1.500‚Ç¨)',
                    labelAge: 'Edad', labelNumberOfPays: 'N√∫mero de pagas',
                    sectionTitleFamily: 'DATOS FAMILIARES (Descendientes y Ascendientes)',
                    labelChildrenUnder25: 'N√∫mero de hijos (<25 a√±os o con discapacidad) que conviven', labelChildrenUnder3: 'De esos hijos, ¬øcu√°ntos son menores de 3 a√±os?',
                    labelAscendantsOver65: 'N¬∫ de ascendientes >65 a√±os que conviven y con rentas < 8.000‚Ç¨', labelAscendantsOver75: 'De esos ascendientes, ¬øcu√°ntos son mayores de 75 a√±os?',
                    sectionTitleDisability: 'DATOS DE DISCAPACIDAD',
                    labelDisabilityTaxpayer: 'Grado de discapacidad del contribuyente',
                    optDisabilityNone: 'Sin discapacidad', optDisability33: 'Entre 33% y 65%', optDisability65: 'M√°s de 65% o movilidad reducida',
                    labelDescDisability33_65: 'N¬∫ de descendientes con discapacidad del 33-65%', labelDescDisabilityOver65: 'N¬∫ de descendientes con discapacidad >65%',
                    labelAscDisability33_65: 'N¬∫ de ascendientes con discapacidad del 33-65%', labelAscDisabilityOver65: 'N¬∫ de ascendientes con discapacidad >65%',
                    country_es: 'Espa√±a', country_de: 'Alemania', country_fr: 'Francia', country_uk: 'Reino Unido', country_us: 'EE.UU.', country_be: 'B√©lgica', country_it: 'Italia', country_se: 'Suecia', country_pt: 'Portugal', country_nl: 'Pa√≠ses Bajos', country_ie: 'Irlanda', country_ch: 'Suiza'
                },
                ca: {
                    documentTitle: 'Dashboard Salarial', pageTitle: 'Dashboard Salarial', authorBy: 'per',
                    grossSalaryLabel: 'Sou Brut Anual (‚Ç¨)', grossSalaryPlaceholder: 'Ex: 30000', calculateBtn: 'Generar Dashboard',
                    annual: 'Anual', monthly: 'Mensual', summaryTitle: 'Resum Financer',
                    companyInvests: 'Cost Empresa', stateCollects: 'Recaptat per l\'Estat', employeeReceives: 'Sou Net Mensual', netSalaryAnnual: 'Sou Net Anual', extraNetPay: 'Paga Extra Neta',
                    extraPaysOf: '{num} pagues extra de',
                    evolutionTitle: 'üìà Evoluci√≥ Salarial', fromSMI: 'Des de (SMI)', upTo: 'Fins a', updateChartBtn: 'Actualitzar', evolutionDisclaimer: "Aquest gr√†fic mostra l'evoluci√≥ exacta dels costos i ingressos segons les dades avan√ßades introdu√Ødes. La l√≠nia vertical marca el seu salari.",
                    breakdownTitle: 'Desglossament de Costos', taxDistributionTitle: 'üèõÔ∏è A qu√® es destinen els teus impostos?',
                    taxDestination: 'Destinaci√≥ de la Despesa', taxPercentagePGE: '% PGE', taxYourContribution: 'La teva Aportaci√≥', total: 'Total',
                    taxDisclaimer: 'Nota: Aquesta taula distribueix el total d\'impostos (IRPF + S.S.) segons els percentatges de despesa dels PGE 2023. √âs un model il¬∑lustratiu.',
                    generalDisclaimer: 'Av√≠s General: Aquest c√†lcul √©s una estimaci√≥ detallada basada en la normativa del 2023. Les xifres reals poden variar per convenis col¬∑lectius, deduccions auton√≤miques espec√≠fiques no contemplades i altres circumst√†ncies personals. No substitueix el consell d\'un professional.',
                    totalCompanyCost: 'üí∞ Cost Total Empresa', ssCompany: 'üèõÔ∏è S.S. (Empresa)', grossSalary: 'üíº Sou Brut', irpf: 'üèõÔ∏è IRPF (Retenci√≥)', ssEmployee: 'üèõÔ∏è S.S. (Treballador)', netSalary: '‚úÖ Sou Net',
                    ofTotal: 'del total', ofGross: 'del brut',
                    chartLabelState: 'Recaptat per l\'Estat', chartLabelNet: 'Rebut pel Treballador (Net)',
                    chartSeriesCompany: 'Cost Empresa', chartSeriesState: 'Recaptat Estat', chartSeriesNet: 'Sou Net',
                    yourSalary: 'El Teu Salari',
                    pensions: 'Pensions', debt: 'Deute P√∫blic (interessos)', transfers: 'Transf. a Adm. P√∫bliques', unemployment: 'Atur', health: 'Sanitat', education: 'Educaci√≥', publicServices: 'Serveis P√∫blics Generals', fomento: 'Foment', defense: 'Defensa i Seguretat', industry: 'Ind√∫stria i Energia', rdi: 'R+D+i i Digitalitzaci√≥', culture: 'Cultura i altres', royalHouse: 'Casa Reial',
                    comparisonTitle: 'üåç Comparativa Internacional', sortByCompanyCost: 'Ordenar per Cost Empresa', sortByStateRevenue: 'Ordenar per Impostos', sortByNetSalary: 'Ordenar per Sou Net',
                    comparisonModeReal: 'An√†lisi Real', comparisonModeHypothesis: 'An√†lisi Hipot√®tica',
                    comparisonDisclaimerReal: 'An√†lisi Real: Compara els sistemes fiscals aplicant el teu sou brut a cada pa√≠s.',
                    comparisonDisclaimerHypothesis: 'An√†lisi Hipot√®tica: Compara quin sou tindries si la inversi√≥ total de l\'empresa fos la mateixa que a Espanya.',
                    comparisonDisclaimerNote: 'Nota: Models fiscals i de seguretat social molt simplificats. Prop√≤sit purament il¬∑lustratiu.',
                    compChartNet: 'Sou Net', compChartStateRevenue: 'Recaptat per l\'Estat',
                    advancedOptions: 'Opcions Avan√ßades (C√†lcul Prec√≠s IRPF)',
                    sectionTitleGeneral: 'DADES GENERALS I SITUACI√ì LABORAL',
                    labelAutonomousCommunity: 'Comunitat Aut√≤noma', labelFamilySituation: 'Situaci√≥ familiar',
                    optSingle: 'Solter, vidu, divorciat o separat legalment', optMarried1: 'Casat i no separat legalment (declaraci√≥ individual)', optMarried2: 'Casat i no separat legalment (c√≤njuge amb rendes < 1.500‚Ç¨)',
                    labelAge: 'Edat', labelNumberOfPays: 'Nombre de pagues',
                    sectionTitleFamily: 'DADES FAMILIARS (Descendents i Ascendents)',
                    labelChildrenUnder25: 'Nombre de fills (<25 anys o amb discapacitat) que conviuen', labelChildrenUnder3: 'D\'aquests fills, quants s√≥n menors de 3 anys?',
                    labelAscendantsOver65: 'N¬∫ d\'ascendents >65 anys que conviuen i amb rendes < 8.000‚Ç¨', labelAscendantsOver75: 'D\'aquests ascendents, quants s√≥n majors de 75 anys?',
                    sectionTitleDisability: 'DADES DE DISCAPACITAT',
                    labelDisabilityTaxpayer: 'Grau de discapacitat del contribuent',
                    optDisabilityNone: 'Sense discapacitat', optDisability33: 'Entre 33% i 65%', optDisability65: 'M√©s de 65% o mobilitat redu√Øda',
                    labelDescDisability33_65: 'N¬∫ de descendents amb discapacitat del 33-65%', labelDescDisabilityOver65: 'N¬∫ de descendents amb discapacitat >65%',
                    labelAscDisability33_65: 'N¬∫ d\'ascendents amb discapacitat del 33-65%', labelAscDisabilityOver65: 'N¬∫ d\'ascendents amb discapacitat >65%',
                    country_es: 'Espanya', country_de: 'Alemanya', country_fr: 'Fran√ßa', country_uk: 'Regne Unit', country_us: 'EUA', country_be: 'B√®lgica', country_it: 'It√†lia', country_se: 'Su√®cia', country_pt: 'Portugal', country_nl: 'Pa√Øsos Baixos', country_ie: 'Irlanda', country_ch: 'Su√Øssa'
                },
                eu: {
                    documentTitle: 'Soldata Arbel', pageTitle: 'Soldata Arbel', authorBy: 'egilea',
                    grossSalaryLabel: 'Urteko Soldata Gordina (‚Ç¨)', grossSalaryPlaceholder: 'Adib: 30000', calculateBtn: 'Arbela Sortu',
                    annual: 'Urtekoa', monthly: 'Hilabetekoa', summaryTitle: 'Finantza Laburpena',
                    companyInvests: 'Enpresaren Kostua', stateCollects: 'Estatuak Bildutakoa', employeeReceives: 'Hileko Soldata Garbia', netSalaryAnnual: 'Urteko Soldata Garbia', extraNetPay: 'Sari Garbia',
                    extraPaysOf: '{num} sari gehigarri, bakoitza',
                    evolutionTitle: 'üìà Soldataren Bilakaera', fromSMI: 'HGGtik', upTo: 'Hona arte', updateChartBtn: 'Eguneratu', evolutionDisclaimer: 'Grafiko honek kostuen eta diru-sarreren bilakaera zehatza erakusten du sartutako datu aurreratuen arabera. Lerro bertikalak zure soldata markatzen du.',
                    breakdownTitle: 'Kostuen Banaketa', taxDistributionTitle: 'üèõÔ∏è Zertara doaz Zure Zergak?',
                    taxDestination: 'Gastuaren Helburua', taxPercentagePGE: '% Aurrekontua', taxYourContribution: 'Zure Ekarpena', total: 'Guztira',
                    taxDisclaimer: 'Oharra: Taula honek zerga guztiak (PFEZ + GS) banatzen ditu 2023ko PGE gastuen portzentajeen arabera. Eredu argigarria da.',
                    generalDisclaimer: 'Ohar Orokorra: Kalkulu hau 2023ko araudian oinarritutako estimazio zehatza da. Benetako zifrak alda daitezke hitzarmen kolektiboen, hemen kontuan hartu gabeko autonomia-erkidegoko kenkari espezifikoen eta beste egoera pertsonal batzuen arabera. Ez du profesional baten aholkua ordezkatzen.',
                    totalCompanyCost: 'üí∞ Enpresaren Kostu Totala', ssCompany: 'üèõÔ∏è G.S. (Enpresa)', grossSalary: 'üíº Soldata Gordina', irpf: 'üèõÔ∏è PFEZ (Atxikipena)', ssEmployee: 'üèõÔ∏è G.S. (Langilea)', netSalary: '‚úÖ Soldata Garbia',
                    ofTotal: 'guztizkoarena', ofGross: 'gordinarena',
                    chartLabelState: 'Estatuak Bildutakoa', chartLabelNet: 'Langileak Jasotakoa (Garbia)',
                    chartSeriesCompany: 'Enpresaren Kostua', chartSeriesState: 'Estatuak Bildutakoa', chartSeriesNet: 'Soldata Garbia',
                    yourSalary: 'Zure Soldata',
                    pensions: 'Pentsioak', debt: 'Zor Publikoa (interesak)', transfers: 'Beste Adm. Publikoei Transf.', unemployment: 'Langabezia', health: 'Osasuna', education: 'Hezkuntza', publicServices: 'Zerbitzu Publiko Orokorrak', fomento: 'Sustapena', defense: 'Defentsa eta Segurtasuna', industry: 'Industria eta Energia', rdi: 'I+G+b eta Digitalizazioa', culture: 'Kultura eta beste batzuk', royalHouse: 'Errege Etxea',
                    comparisonTitle: 'üåç Nazioarteko Konparaketa', sortByCompanyCost: 'Ordenatu Enpresa Kostuaren arabera', sortByStateRevenue: 'Ordenatu Zergen arabera', sortByNetSalary: 'Ordenatu Soldata Garbiaren arabera',
                    comparisonModeReal: 'Benetako Analisia', comparisonModeHypothesis: 'Analisi Hipotetikoa',
                    comparisonDisclaimerReal: 'Benetako Analisia: Konparatu sistema fiskalak zure soldata gordina herrialde bakoitzean aplikatuz.',
                    comparisonDisclaimerHypothesis: 'Analisi Hipotetikoa: Konparatu zer soldata izango zenukeen enpresaren inbertsio totala Espainiakoaren berdina balitz.',
                    comparisonDisclaimerNote: 'Oharra: Eredu fiskal eta gizarte-segurantzako oso sinplifikatuak. Helburu argigarria soilik.',
                    compChartNet: 'Soldata Garbia', compChartStateRevenue: 'Estatuak Bildutakoa',
                    advancedOptions: 'Aukera Aurreratuak (PFEZ Kalkulu Zehatza)',
                    sectionTitleGeneral: 'DATU OROKORRAK ETA LAN EGOERA',
                    labelAutonomousCommunity: 'Autonomia Erkidegoa', labelFamilySituation: 'Familia-egoera',
                    optSingle: 'Ezkongabea, alarguna, dibortziatua edo legez banandua', optMarried1: 'Ezkonduta eta legez banandu gabe (aitorpen indibiduala)', optMarried2: 'Ezkonduta eta legez banandu gabe (ezkontideak < 1.500‚Ç¨-ko errentak ditu)',
                    labelAge: 'Adina', labelNumberOfPays: 'Paga kopurua',
                    sectionTitleFamily: 'FAMILIA DATUAK (Ondorengoak eta Aurrekoak)',
                    labelChildrenUnder25: 'Bizikide diren seme-alaba kopurua (<25 urte edo desgaitasuna dutenak)', labelChildrenUnder3: 'Seme-alaba horietatik, zenbat dira 3 urtetik beherakoak?',
                    labelAscendantsOver65: 'Bizikide diren >65 urteko aurrekoen kopurua, < 8.000‚Ç¨-ko errentekin', labelAscendantsOver75: 'Aurreko horietatik, zenbat dira 75 urtetik gorakoak?',
                    sectionTitleDisability: 'DESGAITASUN DATUAK',
                    labelDisabilityTaxpayer: 'Zergadunaren desgaitasun-maila',
                    optDisabilityNone: 'Desgaitasunik gabe', optDisability33: '%33 eta %65 artean', optDisability65: '%65 baino gehiago edo mugikortasun urria',
                    labelDescDisability33_65: 'Ondorengoen kopurua, %33-65eko desgaitasunarekin', labelDescDisabilityOver65: 'Ondorengoen kopurua, >%65eko desgaitasunarekin',
                    labelAscDisability33_65: 'Aurrekoen kopurua, %33-65eko desgaitasunarekin', labelAscDisabilityOver65: 'Aurrekoen kopurua, >%65eko desgaitasunarekin',
                    country_es: 'Espainia', country_de: 'Alemania', country_fr: 'Frantzia', country_uk: 'Erresuma Batua', country_us: 'AEB', country_be: 'Belgika', country_it: 'Italia', country_se: 'Suedia', country_pt: 'Portugal', country_nl: 'Herbehereak', country_ie: 'Irlanda', country_ch: 'Suitza'
                },
                gl: {
                    documentTitle: 'Panel Salarial', pageTitle: 'Panel Salarial', authorBy: 'por',
                    grossSalaryLabel: 'Soldo Bruto Anual (‚Ç¨)', grossSalaryPlaceholder: 'Ex: 30000', calculateBtn: 'Xerar Panel',
                    annual: 'Anual', monthly: 'Mensual', summaryTitle: 'Resumo Financeiro',
                    companyInvests: 'Custo da Empresa', stateCollects: 'Recadado polo Estado', employeeReceives: 'Soldo Neto Mensual', netSalaryAnnual: 'Soldo Neto Anual', extraNetPay: 'Paga Extra Neta',
                    extraPaysOf: '{num} pagas extra de',
                    evolutionTitle: 'üìà Evoluci√≥n Salarial', fromSMI: 'Dende (SMI)', upTo: 'Ata', updateChartBtn: 'Actualizar', evolutionDisclaimer: 'Este gr√°fico amosa a evoluci√≥n exacta dos custos e ingresos segundo os datos avanzados introducidos. A li√±a vertical marca a posici√≥n do seu salario.',
                    breakdownTitle: 'Desagregaci√≥n de Custos', taxDistributionTitle: 'üèõÔ∏è A que se Destinan os teus Impostos?',
                    taxDestination: 'Destino do Gasto', taxPercentagePGE: '% Orzamento', taxYourContribution: 'A t√∫a Aportaci√≥n', total: 'Total',
                    taxDisclaimer: 'Nota: Esta t√°boa distrib√∫e o total de impostos (IRPF + S.S.) segundo as porcentaxes de gasto dos PXE 2023. √â un modelo ilustrativo.',
                    generalDisclaimer: 'Aviso Xeral: Este c√°lculo √© unha estimaci√≥n detallada baseada na normativa de 2023. As cifras reais poden variar por convenios colectivos, deduci√≥ns auton√≥micas espec√≠ficas non contempladas e outras circunstancias persoais. Non substit√∫e o consello dun profesional.',
                    totalCompanyCost: 'üí∞ Custo Total Empresa', ssCompany: 'üèõÔ∏è S.S. (Empresa)', grossSalary: 'üíº Soldo Bruto', irpf: 'üèõÔ∏è IRPF (Retenci√≥n)', ssEmployee: 'üèõÔ∏è S.S. (Traballador)', netSalary: '‚úÖ Soldo Neto',
                    ofTotal: 'do total', ofGross: 'do bruto',
                    chartLabelState: 'Recadado polo Estado', chartLabelNet: 'Recibido polo Traballador (Neto)',
                    chartSeriesCompany: 'Custo da Empresa', chartSeriesState: 'Recadado polo Estado', chartSeriesNet: 'Soldo Neto',
                    yourSalary: 'O Teu Salario',
                    pensions: 'Pensi√≥ns', debt: 'D√©beda P√∫blica (xuros)', transfers: 'Transf. a Adm. P√∫blicas', unemployment: 'Desemprego', health: 'Sanidade', education: 'Educaci√≥n', publicServices: 'Servizos P√∫blicos Xerais', fomento: 'Fomento', defense: 'Defensa e Seguridade', industry: 'Industria e Enerx√≠a', rdi: 'I+D+i e Dixitalizaci√≥n', culture: 'Cultura e outros', royalHouse: 'Casa Real',
                    comparisonTitle: 'üåç Comparativa Internacional', sortByCompanyCost: 'Ordenar por Custo Empresa', sortByStateRevenue: 'Ordenar por Impostos', sortByNetSalary: 'Ordenar por Soldo Neto',
                    comparisonModeReal: 'An√°lise Real', comparisonModeHypothesis: 'An√°lise Hipot√©tica',
                    comparisonDisclaimerReal: 'An√°lise Real: Compara os sistemas fiscais aplicando o teu soldo bruto a cada pa√≠s.',
                    comparisonDisclaimerHypothesis: 'An√°lise Hipot√©tica: Compara que soldo ter√≠as se o investimento total da empresa fose o mesmo que en Espa√±a.',
                    comparisonDisclaimerNote: 'Nota: Modelos fiscais e de seguridade social moi simplificados. Prop√≥sito puramente ilustrativo.',
                    compChartNet: 'Soldo Neto', compChartStateRevenue: 'Recadado polo Estado',
                    advancedOptions: 'Opci√≥ns Avanzadas (C√°lculo Preciso IRPF)',
                    sectionTitleGeneral: 'DATOS XERAIS E SITUACI√ìN LABORAL',
                    labelAutonomousCommunity: 'Comunidade Aut√≥noma', labelFamilySituation: 'Situaci√≥n familiar',
                    optSingle: 'Solteiro, vi√∫vo, divorciado ou separado legalmente', optMarried1: 'Casado e non separado legalmente (declaraci√≥n individual)', optMarried2: 'Casado e non separado legalmente (c√≥nxuxe con rendas < 1.500‚Ç¨)',
                    labelAge: 'Idade', labelNumberOfPays: 'N√∫mero de pagas',
                    sectionTitleFamily: 'DATOS FAMILIARES (Descendentes e Ascendentes)',
                    labelChildrenUnder25: 'N√∫mero de fillos (<25 anos ou con discapacidade) que conviven', labelChildrenUnder3: 'Deses fillos, cantos son menores de 3 anos?',
                    labelAscendantsOver65: 'N¬∫ de ascendentes >65 anos que conviven e con rendas < 8.000‚Ç¨', labelAscendantsOver75: 'Deses ascendentes, cantos son maiores de 75 anos?',
                    sectionTitleDisability: 'DATOS DE DISCAPACIDADE',
                    labelDisabilityTaxpayer: 'Grao de discapacidade do contribu√≠nte',
                    optDisabilityNone: 'Sen discapacidade', optDisability33: 'Entre 33% e 65%', optDisability65: 'M√°is do 65% ou mobilidade reducida',
                    labelDescDisability33_65: 'N¬∫ de descendentes con discapacidade do 33-65%', labelDescDisabilityOver65: 'N¬∫ de descendentes con discapacidade >65%',
                    labelAscDisability33_65: 'N¬∫ de ascendentes con discapacidade do 33-65%', labelAscDisabilityOver65: 'N¬∫ de ascendentes con discapacidade >65%',
                    country_es: 'Espa√±a', country_de: 'Alema√±a', country_fr: 'Francia', country_uk: 'Reino Unido', country_us: 'EUA', country_be: 'B√©lxica', country_it: 'Italia', country_se: 'Suecia', country_pt: 'Portugal', country_nl: 'Pa√≠ses Baixos', country_ie: 'Irlanda', country_ch: 'Su√≠za'
                },
                oc: {
                    documentTitle: 'Pan√®u Salariau', pageTitle: 'Pan√®u Salariau', authorBy: 'per',
                    grossSalaryLabel: 'S√≤lde Brut Anuau (‚Ç¨)', grossSalaryPlaceholder: 'Ex: 30000', calculateBtn: 'Generar Pan√®u',
                    annual: 'Anuau', monthly: 'Mensuau', summaryTitle: 'Arresumit Financi√®r',
                    companyInvests: 'C√≤st dera Entrepresa', stateCollects: 'Recaptat per er\'Estat', employeeReceives: 'S√≤lde Net Mensuau', netSalaryAnnual: 'S√≤lde Net Anuau', extraNetPay: 'Paga Extra Neta',
                    extraPaysOf: '{num} pagues extra de',
                    evolutionTitle: 'üìà Evolucion Salariau', fromSMI: 'A compdar de (SMI)', upTo: 'Enquia', updateChartBtn: 'Actualizar', evolutionDisclaimer: 'Aguest grafic m√≤stre er\'evolucion exacta des c√≤sti e revenguts segontes es donades avan√ßades introdusides. Era linha verticau marque eth s√≤n salari.',
                    breakdownTitle: 'Desglossament de C√≤sti', taxDistributionTitle: 'üèõÔ∏è A qu√© se destinen es t√≤ns imp√≤sti?',
                    taxDestination: 'Destinacion dera Despesa', taxPercentagePGE: '% PGE', taxYourContribution: 'Era tua Aportacion', total: 'Total',
                    taxDisclaimer: 'N√≤ta: Aguesta taula distribu√≠s eth total d\'imp√≤sti (IRPF + S.S.) segontes es percentatges de despesa des PGE 2023. Ei un mod√®l illustratiu.',
                    generalDisclaimer: 'Av√≠s Generau: Aguest calcul ei ua estimacion detalhada basada ena normatiua de 2023. Es chifres reaus p√≤den variar segontes conv√®nis collectius, deduccions autonomiques especifiques non contemplades e autes circonst√†ncies personaus. Non substitu√≠s eth conselh d\'un professionau.',
                    totalCompanyCost: 'üí∞ C√≤st Totau Empresa', ssCompany: 'üèõÔ∏è S.S. (Entrepresa)', grossSalary: 'üíº S√≤lde Brut', irpf: 'üèõÔ∏è IRPF (Retencion)', ssEmployee: 'üèõÔ∏è S.S. (Trabalhador)', netSalary: '‚úÖ S√≤lde Net',
                    ofTotal: 'deth totau', ofGross: 'deth brut',
                    chartLabelState: 'Recaptat per er\'Estat', chartLabelNet: 'Recebut peth Trabalhador (Net)',
                    chartSeriesCompany: 'C√≤st Empresa', chartSeriesState: 'Recaptat Estat', chartSeriesNet: 'S√≤lde Net',
                    yourSalary: 'Eth T√≤n Salari',
                    pensions: 'Pensions', debt: 'Deute Public (inter√®ssi)', transfers: 'Transf. a Adm. Publiques', unemployment: 'Shens trabalh', health: 'Sanitat', education: 'Educacion', publicServices: 'Servicis Publics Generaus', fomento: 'Foment', defense: 'Defensa e Seguretat', industry: 'Ind√∫stria e Energia', rdi: 'R+D+i e Digitalizacion', culture: 'Cultura e auti', royalHouse: 'Casa Reiau',
                    comparisonTitle: 'üåç Comparativa Internacionau', sortByCompanyCost: 'Ordenar per C√≤st Empresa', sortByStateRevenue: 'Ordenar per Imp√≤sti', sortByNetSalary: 'Ordenar per S√≤lde Net',
                    comparisonModeReal: 'An√†lisi Reau', comparisonModeHypothesis: 'An√†lisi Ipotetica',
                    comparisonDisclaimerReal: 'An√†lisi Reau: Compare es sist√®mes fiscaus en tot aplicar eth t√≤n s√≤lde brut a cada pa√≠s.',
                    comparisonDisclaimerHypothesis: 'An√†lisi Ipotetica: Compaere qu√© s√≤lde auries se er\'inversion totau der\'entrepresa √®re era madeisha qu\'en Espanha.',
                    comparisonDisclaimerNote: 'N√≤ta: Mod√®ls fiscaus e de seguretat sociau f√≤r√ßa simplificadi. Proposit purament illustratiu.',
                    compChartNet: 'S√≤lde Net', compChartStateRevenue: 'Recaptat per er\'Estat',
                    advancedOptions: 'Opcions Avan√ßades (Calcul Prec√≠s IRPF)',
                    sectionTitleGeneral: 'DONADES GENERAUS E SITUACION LABORAU',
                    labelAutonomousCommunity: 'Comunitat Auton√≤ma', labelFamilySituation: 'Situacion familiara',
                    optSingle: 'Solt√®r, veude, divorciat o separat legaument', optMarried1: 'Maridat e non separat legaument (declaracion individuau)', optMarried2: 'Maridat e non separat legaument (c√≤njuge damb rendes < 1.500‚Ç¨)',
                    labelAge: 'Edat', labelNumberOfPays: 'Nombre de pagues',
                    sectionTitleFamily: 'DONADES FAMILIARES (Descendents e Ascendents)',
                    labelChildrenUnder25: 'Nombre de hilhs (<25 ans o damb discapacitat) que conviven', labelChildrenUnder3: 'D\'aguesti hilhs, quenti an mens de 3 ans?',
                    labelAscendantsOver65: 'N¬∫ d\'ascendents >65 ans que conviven e damb rendes < 8.000‚Ç¨', labelAscendantsOver75: 'D\'aguesti ascendents, quenti an m√®s de 75 ans?',
                    sectionTitleDisability: 'DONADES DE DISCAPACITAT',
                    labelDisabilityTaxpayer: 'Grau de discapacitat deth contribuent',
                    optDisabilityNone: 'Shens discapacitat', optDisability33: 'Entre 33% e 65%', optDisability65: 'M√®s de 65% o mobilitat redusida',
                    labelDescDisability33_65: 'N¬∫ de descendents damb discapacitat deth 33-65%', labelDescDisabilityOver65: 'N¬∫ de descendents damb discapacitat >65%',
                    labelAscDisability33_65: 'N¬∫ d\'ascendents damb discapacitat deth 33-65%', labelAscDisabilityOver65: 'N¬∫ d\'ascendents damb discapacitat >65%',
                    country_es: 'Espanha', country_de: 'Alemanha', country_fr: 'Fran√ßa', country_uk: 'Regne Unit', country_us: 'EUA', country_be: 'Belgica', country_it: 'It√†lia', country_se: 'Su√®cia', country_pt: 'Portugal', country_nl: 'Pa√Øsi Baishi', country_ie: 'Irlanda', country_ch: 'So√Øssa'
                }
            };
            
            const irpfData = {
                tramos_estatal: [{ hasta: 12450, tipo: 0.095 }, { hasta: 20200, tipo: 0.12 }, { hasta: 35200, tipo: 0.15 }, { hasta: 60000, tipo: 0.185 }, { hasta: 300000, tipo: 0.225 }, { hasta: Infinity, tipo: 0.235 }],
                tramos_autonomicos: {
                    comun: [{ hasta: 12450, tipo: 0.095 }, { hasta: 20200, tipo: 0.12 }, { hasta: 35200, tipo: 0.15 }, { hasta: 60000, tipo: 0.185 }, { hasta: 300000, tipo: 0.225 }, { hasta: Infinity, tipo: 0.245 }],
                    andalucia: [{ hasta: 12450, tipo: 0.095 }, { hasta: 20200, tipo: 0.12 }, { hasta: 35200, tipo: 0.15 }, { hasta: 60000, tipo: 0.185 }, { hasta: Infinity, tipo: 0.225 }],
                    aragon: [{ hasta: 12450, tipo: 0.095 }, { hasta: 20200, tipo: 0.125 }, { hasta: 35200, tipo: 0.155 }, { hasta: 50000, tipo: 0.20 }, { hasta: Infinity, tipo: 0.25 }],
                    asturias: [{ hasta: 12450, tipo: 0.10 }, { hasta: 20200, tipo: 0.12 }, { hasta: 35200, tipo: 0.15 }, { hasta: 60000, tipo: 0.19 }, { hasta: Infinity, tipo: 0.24 }],
                    baleares: [{ hasta: 10000, tipo: 0.095 }, { hasta: 18000, tipo: 0.12 }, { hasta: 30000, tipo: 0.15 }, { hasta: 50000, tipo: 0.19 }, { hasta: 70000, tipo: 0.235 }, { hasta: Infinity, tipo: 0.25 }],
                    canarias: [{ hasta: 12450, tipo: 0.09 }, { hasta: 17707, tipo: 0.115 }, { hasta: 33007, tipo: 0.14 }, { hasta: 53407, tipo: 0.18 }, { hasta: 90000, tipo: 0.23 }, { hasta: 120000, tipo: 0.24 }, { hasta: Infinity, tipo: 0.25 }],
                    cantabria: [{ hasta: 12450, tipo: 0.095 }, { hasta: 20200, tipo: 0.12 }, { hasta: 35200, tipo: 0.15 }, { hasta: 60000, tipo: 0.185 }, { hasta: Infinity, tipo: 0.225 }],
                    castilla_mancha: [{ hasta: 12450, tipo: 0.095 }, { hasta: 20200, tipo: 0.12 }, { hasta: 35200, tipo: 0.15 }, { hasta: 60000, tipo: 0.185 }, { hasta: Infinity, tipo: 0.225 }],
                    castilla_leon: [{ hasta: 12450, tipo: 0.09 }, { hasta: 20200, tipo: 0.115 }, { hasta: 35200, tipo: 0.14 }, { hasta: 60000, tipo: 0.18 }, { hasta: Infinity, tipo: 0.215 }],
                    catalunya: [{ hasta: 12450, tipo: 0.105 }, { hasta: 17707, tipo: 0.12 }, { hasta: 33007, tipo: 0.155 }, { hasta: 53407, tipo: 0.189 }, { hasta: 90000, tipo: 0.215 }, { hasta: 120000, tipo: 0.235 }, { hasta: 175000, tipo: 0.245 }, { hasta: Infinity, tipo: 0.255 }],
                    extremadura: [{ hasta: 12450, tipo: 0.08 }, { hasta: 19000, tipo: 0.10 }, { hasta: 28000, tipo: 0.125 }, { hasta: 40000, tipo: 0.16 }, { hasta: 60000, tipo: 0.20 }, { hasta: Infinity, tipo: 0.25 }],
                    galicia: [{ hasta: 12450, tipo: 0.09 }, { hasta: 20200, tipo: 0.115 }, { hasta: 35200, tipo: 0.14 }, { hasta: 60000, tipo: 0.18 }, { hasta: Infinity, tipo: 0.225 }],
                    madrid: [{ hasta: 12450, tipo: 0.085 }, { hasta: 17707, tipo: 0.107 }, { hasta: 33007, tipo: 0.128 }, { hasta: 53407, tipo: 0.174 }, { hasta: Infinity, tipo: 0.205 }],
                    murcia: [{ hasta: 12450, tipo: 0.095 }, { hasta: 20200, tipo: 0.1188 }, { hasta: 35200, tipo: 0.147 }, { hasta: 60000, tipo: 0.1813 }, { hasta: Infinity, tipo: 0.225 }],
                    rioja: [{ hasta: 12450, tipo: 0.09 }, { hasta: 20200, tipo: 0.115 }, { hasta: 35200, tipo: 0.145 }, { hasta: 60000, tipo: 0.18 }, { hasta: Infinity, tipo: 0.23 }],
                    valencia: [{ hasta: 12450, tipo: 0.09 }, { hasta: 30000, tipo: 0.12 }, { hasta: 50000, tipo: 0.17 }, { hasta: 65000, tipo: 0.23 }, { hasta: 80000, tipo: 0.25 }, { hasta: Infinity, tipo: 0.295 }],
                }
            };
            
            const formatCurrency = (v) => (typeof v === 'number') ? v.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '';
            const formatPercent = (v) => (typeof v === 'number') ? `${v.toFixed(2)}%` : '';
            
            const translateUI = () => {
                const t = fullTranslations[currentLang] || fullTranslations['es'];
                document.querySelectorAll('[data-translate-key]').forEach(el => { 
                    const key = el.dataset.translateKey; 
                    if (t[key] && !el.dataset.dynamic) el.textContent = t[key]; 
                });
                document.querySelectorAll('[data-translate-placeholder]').forEach(el => { const key = el.dataset.translatePlaceholder; if (t[key]) el.placeholder = t[key]; });
                document.title = t.documentTitle;
            };

            const setLanguage = (lang) => {
                currentLang = lang;
                localStorage.setItem('selectedLanguage', lang);
                document.documentElement.lang = lang;
                translateUI();
                if (Object.keys(annualValues).length > 0) {
                    initCharts();
                    updateDisplay();
                }
            };
            
            const getCssVar = (varName) => getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
            
            const getChartOptions = (type) => {
                const theme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
                const t = fullTranslations[currentLang] || fullTranslations['es'];
                const baseOptions = { chart: { fontFamily: 'Inter, sans-serif', theme: { mode: theme } }, tooltip: { theme: theme, y: { formatter: (val) => formatCurrency(val) } } };

                switch(type) {
                    case 'summary': return { ...baseOptions, series: [], chart: { ...baseOptions.chart, type: 'donut', height: 300 }, labels: [t.chartLabelState, t.chartLabelNet], colors: [getCssVar('--state-color'), getCssVar('--employee-color')], legend: { position: 'bottom', labels: { colors: getCssVar('--text-muted') } }, dataLabels: { enabled: true, formatter: (val, opts) => [val.toFixed(1) + '%', formatCurrency(opts.w.globals.series[opts.seriesIndex])], style: { fontSize: '12px', colors: ['#fff'], fontWeight: 600 }, dropShadow: { enabled: true, top: 1, left: 1, blur: 1, opacity: 0.7 } } };
                    case 'breakdown': return { ...baseOptions, series: [{ data: [] }], chart: { ...baseOptions.chart, type: 'treemap', height: 250 }, plotOptions: { treemap: { enableShades: true, shadeIntensity: 0.5, distributed: true } }, colors: [getCssVar('--state-color'), getCssVar('--state-color'), getCssVar('--state-color'), getCssVar('--employee-color')], dataLabels: { enabled: true, style: { fontSize: '12px', fontWeight: '600' }, formatter: (text, op) => [text, formatPercent((op.value / op.w.globals.seriesTotals[0]) * 100), formatCurrency(op.value)], offsetY: -4 } };
                    case 'taxDistribution': return { ...baseOptions, series: [{ data: [] }], chart: { ...baseOptions.chart, type: 'treemap', height: 300 }, plotOptions: { treemap: { enableShades: true, shadeIntensity: 0.6, distributed: true } }, dataLabels: { enabled: true, style: { fontSize: '12px', fontWeight: '600' }, formatter: (text, op) => [text, formatPercent((op.value / op.w.globals.seriesTotals[0]) * 100), formatCurrency(op.value)], offsetY: -4 } };
                    case 'evolution': return { ...baseOptions, series: [], chart: { ...baseOptions.chart, type: 'line', height: 400, zoom: { enabled: false } }, colors: [getCssVar('--company-color'), getCssVar('--state-color'), getCssVar('--employee-color')], stroke: { width: 3, curve: 'smooth' }, markers: { size: 0 }, xaxis: { type: 'numeric', title: { text: '', style: { color: getCssVar('--text-muted') } }, labels: { style: { colors: getCssVar('--text-muted') }, formatter: (val) => `${(val/1000).toFixed(0)}k ‚Ç¨` } }, yaxis: { title: { text: 'Euros (‚Ç¨)', style: { color: getCssVar('--text-muted') } }, labels: { style: { colors: getCssVar('--text-muted') }, formatter: (val) => `${(val/1000).toFixed(0)}k ‚Ç¨` } }, grid: { borderColor: getCssVar('--border-color') }, legend: { position: 'top', horizontalAlign: 'left', labels: { colors: getCssVar('--text-muted') } }, annotations: { xaxis: [] } };
                    case 'comparison': return { ...baseOptions, series: [], chart: { ...baseOptions.chart, type: 'bar', height: 500, stacked: true }, plotOptions: { bar: { horizontal: true, dataLabels: { total: { enabled: true, offsetX: 0, style: { fontSize: '13px', fontWeight: 900, color: getCssVar('--text-color') } } } } }, stroke: { width: 1, colors: [ getCssVar('--card-bg') ] }, xaxis: { labels: { style: { colors: getCssVar('--text-muted') }, formatter: (val) => `${(val/1000).toFixed(0)}k ‚Ç¨` } }, yaxis: { labels: { style: { colors: getCssVar('--text-muted'), fontWeight: 600, fontSize: '14px' } } }, grid: { borderColor: getCssVar('--border-color') }, legend: { position: 'top', horizontalAlign: 'left' } };
                }
            };
            
            const initCharts = () => {
                Object.keys(charts).forEach(key => charts[key]?.destroy());
                Object.keys(charts).forEach(key => {
                    const el = document.querySelector(`#${key}-chart`);
                    if (el) charts[key] = new ApexCharts(el, getChartOptions(key));
                });
                Object.values(charts).forEach(chart => chart?.render());
            };

            const calculateCuota = (base, tramos) => {
                let cuota = 0, baseRestante = base, baseTramosAnterior = 0;
                for (const tramo of tramos) {
                    if (baseRestante <= 0) break;
                    const baseEnEsteTramo = Math.min(baseRestante, tramo.hasta - baseTramosAnterior);
                    cuota += baseEnEsteTramo * tramo.tipo;
                    baseRestante -= baseEnEsteTramo;
                    baseTramosAnterior = tramo.hasta;
                }
                return cuota;
            };

            const calculateMinimoPersonalFamiliar = () => {
                let minimo = 0;
                const edad = parseInt(document.getElementById('edad').value) || 30;
                minimo += 5550;
                if (edad >= 65) minimo += 1150;
                if (edad >= 75) minimo += 1400;

                const hijos = parseInt(document.getElementById('hijos-menores-25').value) || 0;
                const hijosMenores3 = parseInt(document.getElementById('hijos-menores-3').value) || 0;
                if (hijos > 0) {
                    const minimosDesc = [2400, 2700, 4000, 4500];
                    for (let i = 0; i < hijos; i++) {
                        minimo += (i < 4) ? minimosDesc[i] : minimosDesc[3];
                    }
                    minimo += hijosMenores3 * 2800;
                }

                const asc = parseInt(document.getElementById('ascendientes-mayores-65').value) || 0;
                const ascMayores75 = parseInt(document.getElementById('ascendientes-mayores-75').value) || 0;
                minimo += asc * 1150;
                minimo += ascMayores75 * 1400;

                const discContribuyente = document.getElementById('discapacidad-contribuyente').value;
                if (discContribuyente === '33') minimo += 3000;
                if (discContribuyente === '65') minimo += 9000;
                
                minimo += (parseInt(document.getElementById('desc-discapacidad-33-65').value) || 0) * 3000;
                minimo += (parseInt(document.getElementById('desc-discapacidad-65').value) || 0) * 9000;
                minimo += (parseInt(document.getElementById('asc-discapacidad-33-65').value) || 0) * 3000;
                minimo += (parseInt(document.getElementById('asc-discapacidad-65').value) || 0) * 9000;
                return minimo;
            };

            const calculateIrpfSpain = (sueldoBruto) => {
                const ssTrabajador = sueldoBruto * 0.0645;
                const gastosDeducibles = 2000;
                const rendimientosNetos = sueldoBruto - ssTrabajador - gastosDeducibles;

                let reduccion = 0;
                if (rendimientosNetos <= 14047.5) {
                    reduccion = 6498;
                } else if (rendimientosNetos < 19747.5) {
                    reduccion = 6498 - 1.14 * (rendimientosNetos - 14047.5);
                }
                const baseImponibleGeneral = Math.max(0, rendimientosNetos - reduccion);
                if (baseImponibleGeneral <= 0) return 0;

                const minimoTotal = calculateMinimoPersonalFamiliar();
                const ccaa = document.getElementById('comunidad-autonoma').value;
                const tramosAutonomicos = irpfData.tramos_autonomicos[ccaa] || irpfData.tramos_autonomicos['comun'];
                
                const cuotaEstatalBruta = calculateCuota(baseImponibleGeneral, irpfData.tramos_estatal);
                const cuotaAutonomicaBruta = calculateCuota(baseImponibleGeneral, tramosAutonomicos);
                const cuotaEstatalMinimo = calculateCuota(minimoTotal, irpfData.tramos_estatal);
                const cuotaAutonomicaMinimo = calculateCuota(minimoTotal, tramosAutonomicos);

                const cuotaIntegra = (cuotaEstatalBruta + cuotaAutonomicaBruta) - (cuotaEstatalMinimo + cuotaAutonomicaMinimo);
                return Math.max(0, cuotaIntegra);
            };

            const calculate = () => {
                const sueldoBrutoAnual = parseFloat(sueldoBrutoInput.value);
                if (isNaN(sueldoBrutoAnual) || sueldoBrutoAnual < 0) { alert('Por favor, introduce un sueldo bruto anual v√°lido.'); return; }
                
                const irpf = calculateIrpfSpain(sueldoBrutoAnual);
                const ssTrabajador = sueldoBrutoAnual * 0.0645;
                const ssEmpresa = sueldoBrutoAnual * 0.32;
                
                const costeTotalEmpresa = sueldoBrutoAnual + ssEmpresa;
                const sueldoNeto = sueldoBrutoAnual - ssTrabajador - irpf;
                const totalEstado = ssEmpresa + ssTrabajador + irpf;

                annualValues = { sueldoBrutoAnual, costeTotalEmpresa, ssEmpresa, ssTrabajador, irpf, sueldoNeto, totalEstado, perc_ssEmpresa_parent: (ssEmpresa / costeTotalEmpresa) * 100, perc_bruto_parent: (sueldoBrutoAnual / costeTotalEmpresa) * 100, perc_irpf_parent: (irpf / sueldoBrutoAnual) * 100, perc_ssTrabajador_parent: (ssTrabajador / sueldoBrutoAnual) * 100, perc_neto_parent: (sueldoNeto / sueldoBrutoAnual) * 100, taxDistribution: PGE_DISTRIBUTION.map(item => ({...item, annualAmount: totalEstado * item.percent })) };
                
                if (!charts.summary) initCharts();
                updateDisplay();
                document.getElementById('results').style.display = 'block';
                window.scrollTo({ top: document.getElementById('results').offsetTop - 20, behavior: 'smooth' });
            };

            const updateDisplay = () => {
                if (Object.keys(annualValues).length === 0) return;
                
                const t = fullTranslations[currentLang] || fullTranslations['es'];
                const isMonthly = periodToggle.checked;
                const numeroPagas = parseInt(document.getElementById('numero-pagas').value) || 12;
                const v = annualValues;

                const mainDivisor = isMonthly ? 12 : 1;
                const paysheetDivisor = isMonthly ? numeroPagas : 1;

                const employeeReceivesLabel = document.querySelector('.summary-card.employee .label');
                employeeReceivesLabel.textContent = isMonthly ? t.employeeReceives : t.netSalaryAnnual;
                
                document.getElementById('summary-empresa').textContent = formatCurrency(v.costeTotalEmpresa / mainDivisor);
                document.getElementById('summary-estado').textContent = formatCurrency(v.totalEstado / mainDivisor);
                document.getElementById('summary-trabajador').textContent = formatCurrency(v.sueldoNeto / paysheetDivisor);
                
                charts.summary?.updateOptions({
                    labels: [t.chartLabelState, t.chartLabelNet],
                    series: [v.totalEstado, v.sueldoNeto]
                });
                
                const extraPayCard = document.getElementById('summary-extra-pay-card');
                if (isMonthly && numeroPagas > 12) {
                    const numExtraPays = numeroPagas - 12;
                    const extraPayLabel = document.getElementById('summary-extra-pay-label');
                    extraPayLabel.textContent = t.extraPaysOf.replace('{num}', numExtraPays);
                    extraPayLabel.dataset.dynamic = true;
                    document.getElementById('summary-extra-pay-value').textContent = formatCurrency(v.sueldoNeto / numeroPagas);
                    extraPayCard.style.display = 'flex';
                } else {
                    extraPayCard.style.display = 'none';
                }

                const displayDivisor = mainDivisor;
                charts.breakdown?.updateSeries([{ data: [ { x: t.ssCompany, y: v.ssEmpresa / displayDivisor }, { x: t.irpf, y: v.irpf / displayDivisor }, { x: t.ssEmployee, y: v.ssTrabajador / displayDivisor }, { x: t.netSalary, y: v.sueldoNeto / displayDivisor } ] }]);
                document.getElementById('breakdown-container').innerHTML = `<div class="breakdown-card company-cost"><div class="breakdown-header"><span class="card-info">${t.totalCompanyCost}</span><div class="value-wrapper"><span class="value">${formatCurrency(v.costeTotalEmpresa / displayDivisor)}</span></div></div><div class="nested-cards"><div class="breakdown-card state-tax"><div class="breakdown-header"><span class="card-info">${t.ssCompany}</span><div class="value-wrapper"><span class="value">${formatCurrency(v.ssEmpresa / displayDivisor)}</span><div class="percentages"><span>${formatPercent(v.perc_ssEmpresa_parent)} ${t.ofTotal}</span></div></div></div></div><div class="breakdown-card employee-gross"><div class="breakdown-header"><span class="card-info">${t.grossSalary}</span><div class="value-wrapper"><span class="value">${formatCurrency(v.sueldoBrutoAnual / displayDivisor)}</span><div class="percentages"><span>${formatPercent(v.perc_bruto_parent)} ${t.ofTotal}</span></div></div></div><div class="nested-cards"><div class="breakdown-card state-tax"><div class="breakdown-header"><span class="card-info">${t.irpf}</span><div class="value-wrapper"><span class="value">${formatCurrency(v.irpf / displayDivisor)}</span><div class="percentages"><span>${formatPercent(v.perc_irpf_parent)} ${t.ofGross}</span></div></div></div></div><div class="breakdown-card state-tax"><div class="breakdown-header"><span class="card-info">${t.ssEmployee}</span><div class="value-wrapper"><span class="value">${formatCurrency(v.ssTrabajador / displayDivisor)}</span><div class="percentages"><span>${formatPercent(v.perc_ssTrabajador_parent)} ${t.ofGross}</span></div></div></div></div><div class="breakdown-card employee-net"><div class="breakdown-header"><span class="card-info">${t.netSalary}</span><div class="value-wrapper"><span class="value">${formatCurrency(v.sueldoNeto / displayDivisor)}</span><div class="percentages"><span>${formatPercent(v.perc_neto_parent)} ${t.ofGross}</span></div></div></div></div></div></div></div>`;
                
                const taxTbody = document.getElementById('tax-tbody');
                taxTbody.innerHTML = '';
                const taxDistributionData = [];
                v.taxDistribution.forEach(item => {
                    const amount = item.annualAmount / displayDivisor;
                    taxTbody.innerHTML += `<tr><td>${t[item.key] || item.key}</td><td class="numeric-cell">${formatPercent(item.percent * 100)}</td><td class="numeric-cell">${formatCurrency(amount)}</td></tr>`;
                    taxDistributionData.push({ x: t[item.key] || item.key, y: amount });
                });
                document.getElementById('tax-total').textContent = formatCurrency(v.totalEstado / displayDivisor);
                charts.taxDistribution?.updateSeries([{ data: taxDistributionData }]);

                updateEvolutionControls(displayDivisor);
                generateAndDrawEvolutionChart();
                calculateAndDrawComparison();
            };
            
            const updateEvolutionControls = (divisor) => {
                evolutionSmiInput.value = (SMI_ANNUAL / divisor).toFixed(2);
                evolutionMaxInput.value = (evolutionMaxSalaryAnnual / divisor).toFixed(2);
            };
            
            const generateAndDrawEvolutionChart = () => {
                const isMonthly = periodToggle.checked;
                const divisor = isMonthly ? 12 : 1;
                const minSalary = SMI_ANNUAL;
                const maxSalary = evolutionMaxSalaryAnnual;
                const currentSalary = annualValues.sueldoBrutoAnual;
                const step = (maxSalary - minSalary) / 50;
                const t = fullTranslations[currentLang] || fullTranslations['es'];
                const costeData = [], estadoData = [], netoData = [];
                
                for (let sueldo = minSalary; sueldo <= maxSalary; sueldo += step) {
                    const irpf = calculateIrpfSpain(sueldo);
                    const ssTrabajador = sueldo * 0.0645;
                    const ssEmpresa = sueldo * 0.32;
                    costeData.push({ x: sueldo, y: sueldo + ssEmpresa });
                    estadoData.push({ x: sueldo, y: irpf + ssTrabajador + ssEmpresa });
                    netoData.push({ x: sueldo, y: sueldo - irpf - ssTrabajador });
                }
                
                charts.evolution?.updateOptions({
                    series: [ { name: t.chartSeriesCompany, data: costeData.map(p => ({x: p.x/divisor, y: p.y/divisor})) }, { name: t.chartSeriesState, data: estadoData.map(p => ({x: p.x/divisor, y: p.y/divisor})) }, { name: t.chartSeriesNet, data: netoData.map(p => ({x: p.x/divisor, y: p.y/divisor})) } ],
                    annotations: { xaxis: [{ x: currentSalary / divisor, borderColor: getCssVar('--primary-color'), label: { borderColor: getCssVar('--primary-color'), style: { color: '#fff', background: getCssVar('--primary-color') }, text: t.yourSalary } }] },
                    xaxis: { min: minSalary / divisor, max: maxSalary / divisor, title: { text: `${t.grossSalaryLabel} (${isMonthly ? t.monthly : t.annual})` } },
                });
            };

            const calculateAndDrawComparison = () => {
                const divisor = periodToggle.checked ? 12 : 1;
                const sueldoBrutoBase = annualValues.sueldoBrutoAnual;
                const costeTotalEmpresa_ES = annualValues.costeTotalEmpresa;

                comparisonData = Object.entries(countryData).map(([code, data]) => {
                    let sueldoBrutoAnual, costeEmpresa;
                    if (comparisonMode === 'hypothesis' && code !== 'ES') {
                        costeEmpresa = costeTotalEmpresa_ES;
                        sueldoBrutoAnual = costeEmpresa / (1 + data.ss_empresa);
                    } else {
                        sueldoBrutoAnual = sueldoBrutoBase;
                        costeEmpresa = sueldoBrutoAnual * (1 + data.ss_empresa);
                    }
                    const irpf = (code === 'ES') ? annualValues.irpf : (sueldoBrutoAnual * data.get_irpf(sueldoBrutoAnual));
                    const ssTrabajador = sueldoBrutoAnual * data.ss_trabajador;
                    const sueldoNeto = sueldoBrutoAnual - ssTrabajador - irpf;
                    const impuestosTotales = costeEmpresa - sueldoNeto;
                    return { code, nameKey: data.nameKey, costeEmpresa: costeEmpresa / divisor, impuestosTotales: impuestosTotales / divisor, sueldoNeto: sueldoNeto / divisor };
                });
                sortAndDrawComparisonChart();
            };
            
            const sortAndDrawComparisonChart = () => {
                if (!charts.comparison || comparisonData.length === 0) return;
                comparisonData.sort((a, b) => b[currentSortCriteria] - a[currentSortCriteria]);
                const t = fullTranslations[currentLang] || fullTranslations['es'];
                
                const categories = comparisonData.map((d, i) => `${i + 1}. ${t[d.nameKey] || d.code}`);
                let series, colors;

                if (currentSortCriteria === 'impuestosTotales') {
                    series = [
                        { name: t.compChartStateRevenue, data: comparisonData.map(d => d.impuestosTotales) },
                        { name: t.compChartNet, data: comparisonData.map(d => d.sueldoNeto) }
                    ];
                    colors = [getCssVar('--state-color'), getCssVar('--employee-color')];
                } else {
                    series = [
                        { name: t.compChartNet, data: comparisonData.map(d => d.sueldoNeto) },
                        { name: t.compChartStateRevenue, data: comparisonData.map(d => d.impuestosTotales) }
                    ];
                    colors = [getCssVar('--employee-color'), getCssVar('--state-color')];
                }

                charts.comparison?.updateOptions({
                    series: series,
                    colors: colors,
                    xaxis: { categories: categories },
                    chart: { height: comparisonData.length * 45 + 80 },
                    plotOptions: { bar: { dataLabels: { total: { formatter: (val, opts) => formatCurrency(comparisonData[opts.dataPointIndex].costeEmpresa) } } } },
                    dataLabels: {
                        enabled: true,
                        formatter: (val, { seriesIndex, dataPointIndex }) => {
                            const total = comparisonData[dataPointIndex].costeEmpresa;
                            if (total === 0 || val/total < 0.08) return '';
                            return formatCurrency(val);
                        },
                        style: { colors: ['#fff'], fontWeight: 500 },
                        dropShadow: { enabled: true, top: 1, left: 1, blur: 1, opacity: 0.4 }
                    },
                });

                document.querySelectorAll('.comparison-controls button').forEach(btn => btn.classList.remove('active'));
                if (currentSortCriteria === 'costeEmpresa') sortCostBtn.classList.add('active');
                else if (currentSortCriteria === 'impuestosTotales') sortTaxBtn.classList.add('active');
                else if (currentSortCriteria === 'sueldoNeto') sortNetBtn.classList.add('active');
            };

            const applyTheme = (theme) => {
                document.body.classList.toggle('dark-theme', theme === 'dark');
                localStorage.setItem('theme', theme);
                if (Object.keys(annualValues).length > 0) {
                    initCharts();
                    updateDisplay();
                }
            };
            
            // --- INITIALIZATION & EVENT LISTENERS ---
            const initialLang = localStorage.getItem('selectedLanguage') || 'es';
            langSelector.value = initialLang; 
            setLanguage(initialLang);
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            themeToggle.checked = savedTheme === 'dark'; 
            applyTheme(savedTheme);
            calculateBtn.addEventListener('click', calculate);
            sueldoBrutoInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') calculate(); });
            periodToggle.addEventListener('change', () => { if (Object.keys(annualValues).length > 0) updateDisplay() });
            themeToggle.addEventListener('change', () => applyTheme(themeToggle.checked ? 'dark' : 'light'));
            langSelector.addEventListener('change', (e) => setLanguage(e.target.value));
            redrawEvolutionBtn.addEventListener('click', () => { 
                const isMonthly = periodToggle.checked;
                const divisor = isMonthly ? 12 : 1;
                evolutionMaxSalaryAnnual = parseFloat(evolutionMaxInput.value) / divisor * 12; // Always store as annual
                generateAndDrawEvolutionChart(); 
            });
            sortCostBtn.addEventListener('click', () => { currentSortCriteria = 'costeEmpresa'; sortAndDrawComparisonChart(); });
            sortTaxBtn.addEventListener('click', () => { currentSortCriteria = 'impuestosTotales'; sortAndDrawComparisonChart(); });
            sortNetBtn.addEventListener('click', () => { currentSortCriteria = 'sueldoNeto'; sortAndDrawComparisonChart(); });
            modeRealBtn.addEventListener('click', () => {
                comparisonMode = 'real'; modeRealBtn.classList.add('active'); modeHypothesisBtn.classList.remove('active');
                comparisonModeDescription.textContent = (fullTranslations[currentLang] || fullTranslations.es).comparisonDisclaimerReal;
                if (Object.keys(annualValues).length > 0) calculateAndDrawComparison();
            });
            modeHypothesisBtn.addEventListener('click', () => {
                comparisonMode = 'hypothesis'; modeHypothesisBtn.classList.add('active'); modeRealBtn.classList.remove('active');
                comparisonModeDescription.textContent = (fullTranslations[currentLang] || fullTranslations.es).comparisonDisclaimerHypothesis;
                if (Object.keys(annualValues).length > 0) calculateAndDrawComparison();
            });
        });
    </script>
</body>
</html>